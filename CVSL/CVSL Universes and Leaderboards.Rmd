---
title: "CVSL Universes and Leaderboards"
author: "Erik Larsen"
date: '2023-11-20'
output: 
  html_document:
    toc: yes
    toc_float:
      collapsed: yes
    numbered_sections: yes
    code_folding: hide
---

# Overview

This snippet is a re-vamp of the data cleaning for our fantasy baseball `Strat-O-Matic` dynasty league, [The Central Valley Strat-O-Matic Baseball League (CVSL)](https://sites.google.com/view/cvslbaseball/home).

+ I scrape `FanGraphs (FG)` and `Baseball-Reference (BR)` player Leaderboards for `catchers`, `pitchers`, and `non-catchers`

+ Originally, I downloaded all the data due to scraping difficulty

  - I've revised this since; lots of Encoding and joining issues, spelling issues, etc. that required extensive time to fix

Required packages:

[readr](https://cran.r-project.org/package=readr)

[tidyverse](https://cran.r-project.org/package=tidyverse)

[ggplot2](https://cran.r-project.org/package=ggplot2)

[rvest](https://cran.r-project.org/package=rvest)

[XML](https://cran.r-project.org/package=XML)

[stringr](https://cran.r-project.org/package=stringr) and [stringi](https://cran.r-project.org/package=stringi) to manipulate strings-- this is useful because when you combine tables of different string encodings (i.e. `Baseball Reference` and `FanGraphs`), the tables won't combine!

[baseballr](https://cran.r-project.org/package=baseballr)


# Environment Prep {.tabset .tabset-pills .tabset-fade}

## Load Packages and Functions

Load packages and [data acquisition & processing functions](https://github.com/eriklarsen4/Baseball/blob/main/CVSL/Functions.R)

```{r Package and Function load, include = T, message = F, warning = F, echo = T}
library(readr)
library(tidyverse)
library(rvest)
library(XML)
library(stringr)
library(stringi)
library(baseballr)
library(ggplot2)
library(ggrepel)

source("~/GitHub/Baseball/CVSL/Functions.R")

load("~/GitHub/Baseball/CVSL/2022/CompleteUniversesAndLeaderboardsEnv.RData")
```

```{r old environments, include = F, warning = F, message = F, echo = F}
# load("~/GitHub/Baseball/CVSL/2022/CVSLenv.RData")
# load("~/GitHub/Baseball/CVSL/2022/CVSL_BR_envir.RData")
```

```{r Chadwick db, eval = F, include = F, message = F, warning = F, echo = T}
## use the Chadwick DB as a cross-ref for playerids
CHAD_LU = baseballr::chadwick_player_lu()

  ## concatenate the separated strings for players with initials as first names;
  ## remove players without bbref ids and remove excess columns
CHAD_LU = CHAD_LU %>%
  dplyr::mutate(name_first = case_when(grepl(name_first, pattern = "[A-Z]\\.") ~
                                         gsub(name_first, pattern = "\\s", replacement = ""),
                                       TRUE ~ name_first)) %>%
  dplyr::filter(key_bbref != "") %>%
  dplyr::mutate(Name = paste(name_first, name_last, sep = " ")) %>%
  dplyr::select(contains("name"),
                contains("Name"),
                key_mlbam,
                key_bbref,
                key_fangraphs,
                key_retro,
                contains("mlb_played"))
```

## Scrape and Clean Baseball Reference Hitters Data

Scrape hitting data from `Baseball Reference` for relevant years using the scraping function I developed ([code here](https://github.com/eriklarsen4/Baseball/blob/main/CVSL/Functions.R))

```{r Scrape BR hitting data, eval = F, include = T, message = F, warning = F, echo = T}

for (i in 16:23){
  if (i %% 17 == 0){
    
    Sys.sleep(60)
    BR_PLAYER_STATS_IMPORT_fn(Year = i,
                              Player_data_type = "batting")
    
  } else {
    
    BR_PLAYER_STATS_IMPORT_fn(Year = i,
                              Player_data_type = "batting")
    
  }
}

Player_Batting_ALL = purrr::reduce(mget(ls()[which(grepl(ls(),
                                                         pattern = "Player_batting") == T)]),
                                         full_join)

rm(list = ls()[which(grepl(ls(), pattern = "Player_b") == T)])
```

Add their `player id`s ([function here](https://github.com/eriklarsen4/Baseball/blob/main/CVSL/Functions.R))

```{r Extract hitters names and add playerids, eval = F, include = T, message = F, warning = F, echo = T}

hitternames = Player_Batting_ALL %>%
  dplyr::select(Name) %>%
  as.vector() %>%
  unlist() %>%
  as.character()

hitters = hitternames

Player_Batting_ALL = ID_ADD_fn(df = Player_Batting_ALL,
                               player_type = "hitters",
                               site_abbrev = "bbref")

```

```{r Correct hittername spellings, eval = F, include = F, message = F, warning = F, echo = F}

Player_Batting_ALL = Player_Batting_ALL %>%
  
  
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Jackie") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jackie Bradley")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Vladimir") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Vladimir Guerrero") &
                                                       grepl(key_bbref, pattern = "2")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Souza") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Souza") &
                                                       grepl(name_first, pattern = "Steven")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Ronald") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ronald") &
                                                       grepl(name_matrilineal, pattern = "Blanco")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Dwight") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Dwight Smith") &
                                                       grepl(name_suffix, pattern = "Jr.")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Lourdes") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Lourdes")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Shed") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Shed")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Tatis") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Fernando Tat")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "LaMonte") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "LaMonte Wade")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jazz") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jazz")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Kazmar") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Kazmar")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Luis") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Luis Robert")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Stokes") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Troy Stokes")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Eric Young") &
                                                       grepl(name_suffix, pattern = "Jr.")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     TRUE ~ bbref_id
                                     ),
                lastinit = str_extract(bbref_id, pattern = "[a-z]{1}"),
                
                
                ## correct additional oddities
                bbref_id = case_when(grepl(Name, pattern = "Alejandro") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "De Aza")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Iv") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Iv") &
                                                       grepl(name_last, pattern = "De Jes")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Wily") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Wily Mo")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Van") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Van") &
                                                       grepl(name_first, pattern = "Scott")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Dekker") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "den Dekker")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Gosselin") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Gosselin")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Murphy") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Murphy") &
                                                       grepl(name_given, pattern = "John Ryan")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Tommy") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Tommy") &
                                                       grepl(name_given, pattern = "Thomas Frank")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Yolmer") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Yolmer")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Michael") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Michael Taylor") &
                                                       grepl(name_given, pattern = "Michael A")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Kang") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Kang")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Choi") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Choi") &
                                                       grepl(name_given, pattern = "Ji Man")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Hyun") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Hyun") &
                                                       grepl(name_first, pattern = "Hyun Soo")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Byung") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Byung Ho")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Reed") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Reed") &
                                                       grepl(name_given, pattern = "Andrew Joseph")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Vogelbach") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Vogelbach")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Nicky") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Delmonico")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Granite") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Granite")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Fernandez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jos") &
                                                       grepl(key_bbref, pattern = "fernajo03")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Alex") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Alex") &
                                                       grepl(name_last, pattern = "De Goti")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Bryan") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Bryan") &
                                                       grepl(name_last, pattern = "De La Cruz")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id
                                     ),
                
                ## and their lastname initial
                lastinit = str_extract(bbref_id, pattern = "[a-z]{1}")
                )

Player_Batting_ALL = Player_Batting_ALL %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Bill") &
                                       grepl(Name, pattern = "Hall") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Hall" &
                                                       name_given == "William") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "John") &
                                       grepl(Name, pattern = "McDonald") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "McDonald" &
                                                       mlb_played_last == 2014) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Chris") &
                                       grepl(Name, pattern = "Young") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Young" &
                                                       name_given == "Christopher Brandon") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Nelson") &
                                       grepl(Name, pattern = "Cruz") ~ CHAD_LU %>%
                                       dplyr::filter(name_given == "Nelson Ramon" &
                                                       name_last == "Cruz") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Ike") &
                                       grepl(Name, pattern = "Davis") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Ike Davis" &
                                                       name_given == "Isaac Benjamin") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Luis") &
                                           grepl(Name, pattern = "Jimenez") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Luis Jimenez" &
                                                       name_given == "Luis Domingo") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Boog") &
                                       grepl(Name, pattern = "Powell") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Boog Powell" &
                                                       name_given == "Herschel Mack") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Adam") &
                                           grepl(Name, pattern = "Eaton") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Adam Eaton" &
                                                       name_given == "Adam Cory") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Matt") &
                                       grepl(Name, pattern = "Reynolds") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Matt Reynolds" &
                                                       name_given == "Matthew William") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id))

```

```{r Correct hitter positions, eval = F, include = F, message = F, warning = F, echo = F}
  ## Loop through and tab each team's number of acqusitions for the main acq. types in each year;
    ## Put them in their own dfs
      ## For hitters
Player_Batting_ALL = Player_Batting_ALL %>%
  dplyr::mutate(Positions = gsub(Pos.Summary, pattern = "\\*|\\/|D|H", replacement = "")) %>%
  dplyr::mutate(Positions = case_when(grepl(Positions, pattern = "\\-Mar") ~ gsub(Positions, pattern = "\\-Mar", replacement = "03"),
                                      grepl(Positions, pattern = "\\-Apr") ~ gsub(Positions, pattern = "\\-Apr", replacement = "04"),
                                      grepl(Positions, pattern = "\\-May") ~ gsub(Positions, pattern = "\\-May", replacement = "05"),
                                      grepl(Positions, pattern = "\\-Jun") ~ gsub(Positions, pattern = "\\-Jun", replacement = "06"),
                                      grepl(Positions, pattern = "\\-Jul") ~ gsub(Positions, pattern = "\\-Jul", replacement = "07"),
                                      grepl(Positions, pattern = "\\-Aug") ~ gsub(Positions, pattern = "\\-Aug", replacement = "08"),
                                      grepl(Positions, pattern = "\\-Sep") ~ gsub(Positions, pattern = "\\-Sep", replacement = "09"),
                                      Positions == "" ~ "0",
                                      TRUE ~ Positions))

batPositions = Player_Batting_ALL %>%
  dplyr::select(Positions) %>%
  as.vector() %>%
  unlist() %>%
  as.character()

listy = vector()

for (i in 1:length(batPositions)) {
  listy[i] = str_extract_all(strsplit(batPositions[i], split = "\\D"), pattern = "[:digit:]")
  
  for (j in 1:length(listy[[i]])) {
    
    if (listy[[i]][j] == 0){
      listy[[i]][j] = "DH"
  }
    if (listy[[i]][j] == 1){
      listy[[i]][j] = "P"
  }
    if (listy[[i]][j] == 2){
      listy[[i]][j] = "C"
  }
    if (listy[[i]][j] == 3){
      listy[[i]][j] = "1B"
  }
    if (listy[[i]][j] == 4){
      listy[[i]][j] = "2B"
  }
    if (listy[[i]][j] == 5){
      listy[[i]][j] = "3B"
  }
    if (listy[[i]][j] == 6){
      listy[[i]][j] = "SS"
  }
    if (listy[[i]][j] == 7){
      listy[[i]][j] = "LF"
  }
    if (listy[[i]][j] == 8){
      listy[[i]][j] = "CF"
  }
    if (listy[[i]][j] == 9){
      listy[[i]][j] = "RF"
    }
    }
  batPositions[i] = paste(unlist(listy[[i]]), collapse = " ")
}


Player_Batting_ALL = Player_Batting_ALL %>%
  dplyr::mutate(Positions = batPositions)

rm(batPositions)
rm(listy)
```

## Scrape and Clean Baseball Reference Pitching Data

Scrape pitching data from `Baseball Reference` for relevant years; same function as for hitters, but tailored to pitchers

```{r Scrape BR pitching data, eval = F, include = T, message = F, warning = F, echo = T}

for (i in 16:23){
  if (i %% 17 == 0){
    
    Sys.sleep(60)
    BR_PLAYER_STATS_IMPORT_fn(Year = i,
                              Player_data_type = "pitching")
    
  } else {
    
    BR_PLAYER_STATS_IMPORT_fn(Year = i,
                              Player_data_type = "pitching")
    
  }
}

Player_Pitching_ALL = purrr::reduce(mget(ls()[which(grepl(ls(),
                                                         pattern = "Player_pitching") == T)]),
                                         full_join)

rm(list = ls()[which(grepl(ls(), pattern = "Player_p") == T)])
```

Add their `player id`s

```{r Add playerids to pitchers df, eval = F, include = T, message = F, warning = F, echo = T}
pitchernames = Player_Pitching_ALL %>%
  dplyr::select(Name) %>%
  as.vector() %>%
  unlist() %>%
  as.character()

Player_Pitching_ALL = ID_ADD_fn(df = Player_Pitching_ALL,
                                player_type = "pitchers",
                                site_abbrev = "bbref")
```

```{r Correct pitchername spellings, eval = F, include = F, message = F, warning = F, echo = F}
Player_Pitching_ALL = Player_Pitching_ALL %>%
  
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "III") &
                                       grepl(Name, pattern = "Alvarez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Henderson")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "III") &
                                       grepl(Name, pattern = "Vidal") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "nunovi01") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Fernando") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Fernando") &
                                                       grepl(name_last, pattern = "Rodr")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Carl") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Carl") &
                                                       grepl(name_last, pattern = "Edwards")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Lance") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "McCullers") &
                                                       name_suffix == "Jr.") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Wright") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Mike") &
                                                       grepl(name_last, pattern = "Wright")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Leiter") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Leiter") &
                                                       name_suffix == "Jr.") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Underwood") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "Underwood") &
                                                       grepl(name_given, pattern = "Duane Lee")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Flores") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "Flores") &
                                                       grepl(name_first, pattern = "Bernardo")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Honeywell") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "Honeywell")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     TRUE ~ bbref_id),
                
                ## Des
                bbref_id = case_when(grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Justin") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Justin" &
                                                       grepl(name_last, pattern = "Fratus")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Frankie") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "De") &
                                                       grepl(name_first, pattern = "Frankie")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Dane") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Dane" &
                                                       grepl(name_last, pattern = "Rosa")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Jorge") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Jorge" &
                                                       grepl(name_last, pattern = "De La")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Rubby") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Rubby") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       grepl(Name, pattern = "Eury") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Eury" &
                                                       name_last == "De La Rosa") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Fautino") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Fautino") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Enerio") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Enerio") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Cole") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Cole" &
                                                       name_last == "De Vries") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jose") &
                                       grepl(Name, pattern = "Torre") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Jose" &
                                                       name_last == "De La Torre") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Jorge") &
                                       grepl(Name, pattern = "Leon") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Jorge" &
                                                       name_last == "De Leon") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Abel") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Abel" &
                                                       name_last == "De Los Santos") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Paula") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Jose" &
                                                       name_last == "De Paula") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       grepl(Name, pattern = "Joel") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Joel" &
                                                       name_last == "De La Cruz") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Jos") &
                                       grepl(Name, pattern = "Le") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jos") &
                                                       grepl(name_given, pattern = "Eugenio")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jong") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Chase" &
                                                       name_last == "De Jong") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Enyel") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Enyel") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Pozo") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Pozo") &
                                                       name_first == "Miguel") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     is.na(bbref_id) &
                                       grepl(Name, pattern = "Hurk") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "van den Hurk")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     is.na(bbref_id) &
                                       grepl(Name, pattern = "Oviedo") ~ CHAD_LU %>%
                                       dplyr::filter(name_given == "Juan Carlos" &
                                                       name_last == "Oviedo") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     is.na(bbref_id) &
                                       grepl(Name, pattern = "Niese") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Niese") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     is.na(bbref_id) &
                                       grepl(Name, pattern = "JC") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "J") &
                                                       grepl(Name, pattern = "C") &
                                                       grepl(Name, pattern = "Ram")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Ryu") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Ryu" &
                                                       name_first == "Hyun Jin") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     TRUE ~ bbref_id),
                
                ## misfits
                bbref_id = case_when(grepl(Name, pattern = "Boyd") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Boyd" &
                                                       grepl(Name, pattern = "Matt")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Chi") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Chi Chi")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Sugar") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Sugar Ray")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Josh") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Josh") &
                                                       name_given == "Joshua Allen") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Felipe") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "V") &
                                                       name_given == "Felipe Javier") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Bowman") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Bowman" &
                                                       name_first == "Matthew") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Chargois") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Chargois") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Whalen") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Whalen") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Chasen Bradford") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Chase" &
                                                       name_given == "Chasen David") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Infante") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Infante" &
                                                       grepl(name_first, pattern = "Greg")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "King") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "King" &
                                                       grepl(name_first, pattern = "Mi")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Reed") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Reed" &
                                                       name_first == "A.J.") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Lakins") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Travis" &
                                                       name_last == "Lakins") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Ponce") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Daniel" &
                                                       grepl(name_last, pattern = "Ponce")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Josh") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "D.") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Josh") &
                                                       name_given == "Joshua Dwayne") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Lakins") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Travis" &
                                                       name_last == "Lakins") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Locke") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Locke") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Daniel") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Cam") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Dan") &
                                                       grepl(name_last, pattern = "Cam")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Vladimir") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Vladimir" &
                                                       grepl(name_last, pattern = "Guti")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Kwang") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Kim" &
                                                       grepl(name_first, pattern = "Kwang")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Lynch") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Lynch" &
                                                       name_first == "Daniel") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id
                                     ),
                lastinit = str_extract(bbref_id, pattern = "[a-z]{1}")
  ) %>%
  dplyr::filter(!is.na(bbref_id))


Player_Pitching_ALL = Player_Pitching_ALL %>%
  dplyr::filter(bbref_id %notin% Player_Batting_ALL$bbref_id) %>%
  dplyr::filter(bbref_id != "mcdonjo01") %>%
  dplyr::filter(bbref_id != "fieldjo04") %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Mike") &
                                       grepl(Name, pattern = "Adams") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Adams" &
                                                       name_given == "Jon Michael") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Rich") &
                                       grepl(Name, pattern = "Thompson") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Thompson" &
                                                       name_given == "Richard Graeme") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Freddy") &
                                       grepl(Name, pattern = "Garcia") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Freddy Garcia" &
                                                       name_given == "Freddy Antonio") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Joe") &
                                       grepl(Name, pattern = "Kelly") ~CHAD_LU %>%
                                       dplyr::filter(name_given == "Joseph William" &
                                                       name_last == "Kelly") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Josh") &
                                       grepl(Name, pattern = "Fields") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Josh Fields" &
                                                       name_given == "Joshua David") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Joe") &
                                       grepl(Name, pattern = "Smith") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Joe Smith" &
                                                       name_given == "Joseph Michael") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Diego") &
                                       grepl(Name, pattern = "Castillo") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Diego Castillo" &
                                                       name_given == "Diego") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Austin") &
                                       grepl(Name, pattern = "Davis") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Austin Davis" &
                                                       name_given == "Austin Richard") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Erik") &
                                       grepl(Name, pattern = "Johnson") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Erik Johnson" &
                                                       name_given == "Erik Craig") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jeff") &
                                       grepl(Name, pattern = "Gray") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Jeff Gray" &
                                                       name_given == "Jeffrey Michael") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Logan") &
                                       grepl(Name, pattern = "Allen") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Logan Allen" &
                                                       name_given == "Logan Shane") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Walker") &
                                       grepl(Name, pattern = "Lockett") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Walker Lockett") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Luis") &
                                       grepl(Name, pattern = "Castillo") &
                                       GS > 0  ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Luis Castillo") & 
                                                       name_given == "Luis Miguel") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id
                                     ),
                
                lastinit = str_extract(bbref_id, pattern = "[a-z]{1}")
  )
```

## Account for Players Who Changed Teams

+ identify players who changed teams in-season

```{r Identify players who changed teams, eval = F, include = T, message = F, warning = F, echo = T}

Team_Changers_hitters = Player_Batting_ALL %>%
  dplyr::filter(grepl(Tm, pattern = "TOT")) %>%
  dplyr::select(Name, lastinit, bbref_id, Year) %>%
  dplyr::distinct()


Team_Changers_pitchers = Player_Pitching_ALL %>%
  dplyr::filter(grepl(Tm, pattern = "TOT")) %>%
  dplyr::select(Name, lastinit, bbref_id, Year) %>%
  dplyr::distinct()

```

+ scrape the players' `Baseball Reference` player pages to identify which teams for whom these players played

  + for hitters first
  
  + aggregate the data

```{r Scrape Individual hitters pages, eval = F, include = F, message = F, warning = F, echo = T}

for (i in 338:nrow(Team_Changers_hitters)){
  if (i %% 17 == 0) {
    
    Sys.sleep(60)
    
    BR_PLAYER_CHANGER_IMPORT_fn(year = Team_Changers_hitters$Year[i],
                                lastinitial = Team_Changers_hitters$lastinit[i],
                                bbref_id = Team_Changers_hitters$bbref_id[i],
                                Player_data_type = "batting")
    
  } else {
    
    BR_PLAYER_CHANGER_IMPORT_fn(year = Team_Changers_hitters$Year[i],
                                lastinitial = Team_Changers_hitters$lastinit[i],
                                bbref_id = Team_Changers_hitters$bbref_id[i],
                                Player_data_type = "batting")
    
  }
}


Changing_hitters = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Changer_") == T)]), full_join)
rm(list = ls()[which(grepl(ls(), pattern = "Changer_") == T)])

Team_Changers_hitters = Team_Changers_hitters %>%
  dplyr::filter(!(grepl(Name, pattern = "Luke") &
                  grepl(Name, pattern = "Weaver"))) %>%
  dplyr::filter(!(grepl(Name, pattern = "Anthony") &
                    grepl(Name, pattern = "Bass"))) %>%
  dplyr::ungroup() %>%
  left_join(Changing_hitters, by = c("lastinit", "bbref_id", "Year")) %>%
  # dplyr::mutate(Tm = case_when(is.na(Tm.x) ~ Tm.y,
  #                              TRUE ~ Tm.x)) %>%
  # dplyr::select(-Tm.x, -Tm.y) %>%
  dplyr::mutate(From = case_when(bbref_id == lead(bbref_id) ~ Tm,
                                 TRUE ~ ""),
                From = case_when(From == ""  ~ lag(From),
                                 TRUE ~ From),
                To = case_when(bbref_id == lag(bbref_id) ~ Tm,
                               TRUE ~ ""),
                To = case_when(To == "" ~ lead(To),
                               TRUE ~ To)) %>%
  dplyr::distinct() %>%
  # dplyr::group_by(bbref_id, Year, Tm) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(bbref_id, Year, Tm) %>%
  dplyr::select(-From, -To) %>%
  dplyr::distinct()


```

  + repeat for pitchers
  
```{r Scrape Individual pitchers pages, eval = F, include = T, message = F, warning = F, echo = T}

for (i in 1:nrow(Team_Changers_pitchers)){
  if (i %% 17 == 0) {
    
    Sys.sleep(60)
    
    BR_PLAYER_CHANGER_IMPORT_fn(year = Team_Changers_pitchers$Year[i],
                                lastinitial = Team_Changers_pitchers$lastinit[i],
                                bbref_id = Team_Changers_pitchers$bbref_id[i],
                                Player_data_type = "pitching")
    
  } else {
    
    BR_PLAYER_CHANGER_IMPORT_fn(year = Team_Changers_pitchers$Year[i],
                                lastinitial = Team_Changers_pitchers$lastinit[i],
                                bbref_id = Team_Changers_pitchers$bbref_id[i],
                                Player_data_type = "pitching")
    
  }
}

  ## join all the individual dfs
Changing_pitchers = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Changer_") == T)]), full_join)
  ## remove all the individual dfs
rm(list = ls()[which(grepl(ls(), pattern = "Changer_"))])

  ## aggregate by player-team-year to account for the salaries to team payrolls from mid-season
    ## player acquisitions
Team_Changers_pitchers = Team_Changers_pitchers %>%
  left_join(Changing_pitchers, by = c("lastinit", "bbref_id", "Year")) %>%
  dplyr::mutate(From = case_when(bbref_id == lead(bbref_id) ~ Tm,
                                 TRUE ~ ""),
                From = case_when(From == ""  ~ lag(From),
                                 TRUE ~ From),
                To = case_when(bbref_id == lag(bbref_id) ~ Tm,
                               TRUE ~ ""),
                To = case_when(To == "" ~ lead(To),
                               TRUE ~ To)) %>%
  dplyr::distinct() %>%
  dplyr::ungroup() %>%
  dplyr::group_by(bbref_id, Year, Tm) %>%
  dplyr::select(-From, -To) %>%
  dplyr::distinct()

```

  + replace data

```{r Integrate the hitters changers data, eval = F, include = T, message = F, warning = F, echo = T}
  ## join all hitters and pitchers who changed teams
# Team_Transactions_ALL = Team_Changers_hitters %>%
  # full_join(Team_Changers_pitchers)

# Team_Changers_ALL %>% # check to see all players are accounted for
#   dplyr::filter(is.na(Tm))

  ## Extract the data of the players who changed teams for last team they played for in a season
x = Team_Changers_hitters %>%
  dplyr::ungroup() %>%
  dplyr::group_by(Name, lastinit, bbref_id, Year) %>%
  dplyr::slice(n()) %>%
  dplyr::ungroup() %>%
  dplyr::right_join(Player_Batting_ALL, by = c("Name", "lastinit", "bbref_id", "Year")) %>%
  dplyr::filter(Tm.y == "TOT") %>%
  dplyr::group_by(bbref_id, Year, Tm.x) %>%
  dplyr::mutate(idx = case_when(bbref_id == lag(bbref_id) &
                                  Year == lag(Year) &
                                  Tm.x == lag(Tm.x) ~ 1,
                                TRUE ~ 0), .after = 3) %>%
  dplyr::ungroup() %>%
  dplyr::filter(idx == 0) %>%
  dplyr::select(-idx) %>%
  dplyr::mutate(Tm = case_when(Tm.y == "TOT" ~ Tm.x,
                               TRUE ~ Tm.y), .after = 3) %>%
  dplyr::select(-Tm.y, -Tm.x)

  ## replace the "TOT" with the team they ended the season with
y = Player_Batting_ALL %>%
  dplyr::filter(Tm == "TOT") %>%
  dplyr::rename(Team = Tm) %>%
  dplyr::distinct() %>%
  left_join(x) %>%
  dplyr::select(-Team) %>%
  dplyr::relocate(Tm, .after = "Age") %>%
  dplyr::filter(!is.na(Tm))# %>%
  # dplyr::select(-Tm.x)

  ## Re-define the data by IDing the players who were traded, replacing all player seasons with their totals
    ## where, if they were traded, only their total and for the team they ended with are shown
Player_Batting_ALL2 = Player_Batting_ALL %>%
  full_join(y, by = c("Name", "lastinit", "bbref_id", "Bats", "Age", "Year",
                      "WAR", "RAR", "Positions", "G", "PA", "AB", "R", "H", "2B", "3B", "HR",
                      "RBI", "SB", "CS", "BB", "SO", "BA", "OBP", "SLG", "OPS",
                      "OPS+", "TB", "GDP", "HBP", "SH", "SF", "IBB", "Pos.Summary",
                      "Rbat", "Rbaser", "Rdp", "Rfield", "Rpos", "RAA", "Rrep",
                      "oWAR", "dWAR", "oRAR", "WAA")) %>%
  dplyr::mutate(Tm = case_when(Tm.x == "TOT" ~ Tm.y,
                               TRUE ~ Tm.x), .after = 5) %>%
  dplyr::mutate(Traded = case_when(Tm.x == "TOT" ~ 1,
                                   TRUE ~ 0), .after = 6) %>%
  dplyr::mutate(Lg = Lg.x, .after = 6) %>%
  dplyr::mutate(rm_idx = case_when(bbref_id == lag(bbref_id) ~ 1,
                                   TRUE ~ 0), .after = 6) %>%
  dplyr::filter( 
    # (Traded == 0 & rm_idx == 0) |
    #                (Traded == 1) 
                 rm_idx == 0 ) %>%
  dplyr::select(Name, lastinit, bbref_id, Age, Year, Tm, Lg,
                Traded, Bats, WAR, RAR, Positions, G, PA, AB, R, H, `2B`,
                `3B`, HR, RBI, SB, CS, BB, SO, BA, OBP, SLG, OPS,
                `OPS+`, TB, GDP, HBP, SH, SF, IBB, Rbat, Rbaser,
                Rdp, Rfield, Rpos, RAA, Rrep, oWAR, dWAR, oRAR, WAA,
                -Lg.x, -Lg.y, -rm_idx, -Tm.x, -Tm.y, -Pos.Summary) #%>%
  # dplyr::filter( (Traded == 1 & Lg == "MLB") | (Traded == 0))

rm(x)
rm(y)
```

```{r Integrate the pitchers changers data, eval = F, include = T, message = F, warning = F, echo = T}
  ## join all hitters and pitchers who changed teams
# Team_Transactions_ALL = Team_Changers_hitters %>%
  # full_join(Team_Changers_pitchers)

# Team_Changers_ALL %>% # check to see all players are accounted for
#   dplyr::filter(is.na(Tm))

  ## Extract the data of the players who changed teams for last team they played for in a season
x = Team_Changers_pitchers %>%
  dplyr::ungroup() %>%
  dplyr::group_by(Name, lastinit, bbref_id, Year) %>%
  dplyr::slice(n()) %>%
  dplyr::ungroup() %>%
  dplyr::right_join(Player_Pitching_ALL, by = c("Name", "lastinit", "bbref_id", "Year")) %>%
  dplyr::filter(Tm.y == "TOT") %>%
  dplyr::group_by(bbref_id, Year, Tm.x) %>%
  dplyr::mutate(idx = case_when(bbref_id == lag(bbref_id) &
                                  Year == lag(Year) &
                                  Tm.x == lag(Tm.x) ~ 1,
                                TRUE ~ 0), .after = 3) %>%
  dplyr::ungroup() %>%
  dplyr::filter(idx == 0) %>%
  dplyr::select(-idx) %>%
  dplyr::mutate(Tm = case_when(Tm.y == "TOT" ~ Tm.x,
                               TRUE ~ Tm.y), .after = 3) %>%
  dplyr::select(-Tm.y, -Tm.x)

  ## replace the "TOT" with the team they ended the season with
y = Player_Pitching_ALL %>%
  dplyr::filter(Tm == "TOT") %>%
  dplyr::rename(Team = Tm) %>%
  dplyr::distinct() %>%
  left_join(x) %>%
  dplyr::select(-Team) %>%
  dplyr::relocate(Tm, .after = "Age") %>%
  dplyr::filter(!is.na(Tm))

  ## Re-define the data by IDing the players who were traded, replacing all player seasons with their totals
    ## where, if they were traded, only their total and for the team they ended with are shown
Player_Pitching_ALL2 = Player_Pitching_ALL %>%
  full_join(y, by = c("Name", "lastinit", "bbref_id", "Throws", "Age", "W", "L",
                      "W-L%", "ERA", "G", "GS", "GF", "CG", "SHO", "SV", "IP",
                      "H", "R", "ER", "HR", "BB", "IBB", "SO", "HBP", "BK", "WP",
                      "BF", "ERA+", "FIP", "WHIP", "H9", "HR9", "BB9", "SO9",
                      "SO/W", "Year", "RA9", "RA9opp", "RA9def", "RA9role", "PPFp",
                      "RA9avg", "RAA", "WAA", "gmLI", "WAAadj", "WAR", "RAR", "waaWL%",
                      "162WL%", "Salary", "Acquired", "RA9extras")) %>%
  dplyr::mutate(Tm = case_when(Tm.x == "TOT" ~ Tm.y,
                               TRUE ~ Tm.x), .after = 5) %>%
  dplyr::mutate(Traded = case_when(Tm.x == "TOT" ~ 1,
                                   TRUE ~ 0), .after = 6) %>%
  dplyr::mutate(Lg = Lg.x, .after = 6) %>%
  dplyr::mutate(rm_idx = case_when(bbref_id == lag(bbref_id) ~ 1,
                                   TRUE ~ 0), .after = 6) %>%
  dplyr::filter( 
    # (Traded == 0 & rm_idx == 0) |
    #                (Traded == 1) 
                 rm_idx == 0 ) %>%
  dplyr::select(-Lg.x, -Lg.y, -rm_idx, -Tm.x, -Tm.y) #%>%
  # dplyr::filter( (Traded == 1 & Lg == "MLB") | (Traded == 0) )

rm(x)
rm(y)
```


## Scrape Splits Data

Show the scrape code for acquiring every players' platoon splits

```{r Correct hitter names for scraping splits, eval = F, include = F, warning = F, message = F, echo = F}
Player_Batting_ALL2 = Player_Batting_ALL2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Ryan") &
                                       grepl(Name, pattern = "Braun") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Ryan Braun" &
                                                       name_given == "Ryan Joseph") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Tom") &
                                       grepl(Name, pattern = "Murphy") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Tom Murphy") &
                                                       name_given == "Thomas James") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Johnny") &
                                       grepl(Name, pattern = "Davis") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Johnny Davis") &
                                                       name_given == "Johnathan Lewis") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Fernando") &
                                       grepl(Name, pattern = "Tatis") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Fernando Tat") &
                                                       name_given == "Fernando Gabriel") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "McCarthy") &
                                       grepl(Name, pattern = "Joe") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Joe McCarthy") &
                                                       name_given == "Joseph Edward") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Will") &
                                       grepl(Name, pattern = "Smith") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Will Smith") &
                                                       name_given == "William Dills") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ji") &
                                       grepl(Name, pattern = "Hwan") &
                                       grepl(Name, pattern = "Bae") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ji Hwan Bae")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Yusniel") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Yusniel")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Calvin") &
                                       grepl(Name, pattern = "Mitchell") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Cal Mitchell")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Carlos") &
                                       grepl(Name, pattern = "P") &
                                       Tm == "CHW" ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Carlos") &
                                                       grepl(Name, pattern = "P") &
                                                       name_given == "Carlos Jesus") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Josh") &
                                       grepl(Name, pattern = "Smith") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Josh Smith") &
                                                       name_given == "Josh Harris") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Elly") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Elly De")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id),
                
                lastinit = str_extract(bbref_id, pattern = "[a-z]{1}"))
```

```{r Scrape BR hitting splits, eval = F, include = F, message = F, warning = F, echo = T}

  ## Yearly player split leaderboards are not available on BBRef
    ## these must be scraped from individual player pages

  # latin spellings are encoded differently for 2023 season, will throw an error
for (i in 1615:nrow(Player_Batting_ALL2)) {
  if (i %% 17 == 0) {
      
      Sys.sleep(60)
      BR_PLAYER_SPLITS_IMPORT_fn(Year = str_extract(as.character(Player_Batting_ALL2$Year[i]),
                                                    pattern = "[0-9]{2}$"),
                                 Player_data_type = "batting",
                                 playerid = Player_Batting_ALL2$bbref_id[i])
      
    } else {
      
      BR_PLAYER_SPLITS_IMPORT_fn(Year = str_extract(as.character(Player_Batting_ALL2$Year[i]),
                                                    pattern = "[0-9]{2}$"),
                                 Player_data_type = "batting",
                                 playerid = Player_Batting_ALL2$bbref_id[i])
      
    }
}


  ## combine all the dfs and remove
Hitter_splits = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "batting_splits") == T)]), full_join)
rm(list = ls()[which(grepl(ls(), pattern = "batting_splits_") == T)])

## Add searchable names and more player information to the splits df
Hitter_splits = Hitter_splits %>%
  dplyr::select(-GS, -I) %>%
  dplyr::mutate(Year = as.double(Year)) %>%
  inner_join(Player_Batting_ALL2, by = c("bbref_id", "Year")) %>%
  dplyr::relocate(c(Year, Name, bbref_id, lastinit, Bats, Age, Tm, Traded, Split, Positions), .before = 1) %>%
  dplyr::select(-contains(".y"), -c(38:75)) %>%
  dplyr::rename_at(vars(contains(".x")), ~ str_remove(., ".x")) %>%
  dplyr::mutate(key_bbref = bbref_id) %>%
  
  ## replace the Name from the Hitter Splits df with the "Name" column from the CHAD_LU df, which IS searchable
  left_join(CHAD_LU, by = "key_bbref") %>%
  dplyr::relocate(Name.y, .before = Name.x) %>%
  dplyr::rename(Name = Name.y) %>%
  dplyr::select(-contains("name_"), -contains("key"), -contains("mlb"), -Name.x)
```

```{r Correct pitcher names to scrape splits, eval = F, include = F, message = F, warning = F, echo = F}
Player_Pitching_ALL2 = Player_Pitching_ALL2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Luis") &
                                       grepl(Name, pattern = "Castillo") &
                                       (grepl(Tm, pattern = "CIN|SEA") | is.na(Tm)) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Luis Castillo") &
                                                       name_given == "Luis Miguel") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                       
                                     grepl(Name, pattern = "Carlos") &
                                       grepl(Name, pattern = "Martinez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Carlos Martinez") &
                                                       name_given == "Carlos Ernesto") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Charlie") &
                                       grepl(Name, pattern = "Morton") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Charlie Morton") &
                                                       name_given == "Charles Alfred") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Drew") &
                                       grepl(Name, pattern = "Anderson") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Drew Anderson") &
                                                       name_given == "Andrew James") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jos") &
                                       grepl(Name, pattern = "Rodr") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "rodrijo07") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Luis") &
                                       grepl(Name, pattern = "Garc") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Luis") &
                                                       grepl(Name, pattern = "Garc") &
                                                       name_given == "Luis Amado") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Paul") &
                                       grepl(Name, pattern = "Campbell") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Paul Campbell") &
                                                       name_given == "Paul Alan") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Luis") &
                                       grepl(Name, pattern = "Medina") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Luis Medina") &
                                                       name_given == "Luis Angel") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id),
                
                Tm = case_when(bbref_id == "castilu02" &
                                 is.na(Tm) ~ "SEA",
                               
                               TRUE ~ Tm),
                
                Acquired = case_when(bbref_id == "castilu02" &
                                       Tm == "CIN" ~ "Amateur Draft"),
                
                lastinit = str_extract(bbref_id, pattern = "[a-z]{1}"))

```

```{r Scrape BR pitching splits, eval = F, include = T, message = F, warning = F, echo = T}

for(i in 1:nrow(Player_Pitching_ALL2)){
  if (i %% 17 == 0) {
    
    Sys.sleep(60)
    BR_PLAYER_SPLITS_IMPORT_fn(Year = str_extract(as.character(Player_Pitching_ALL2$Year[i]),
                                                  pattern = "[0-9]{2}$"),
                               Player_data_type = "pitching",
                               playerid = Player_Pitching_ALL2$bbref_id[i])
  } else {
    
    BR_PLAYER_SPLITS_IMPORT_fn(Year = str_extract(as.character(Player_Pitching_ALL2$Year[i]),
                                                  pattern = "[0-9]{2}$"),
                               Player_data_type = "pitching",
                               playerid = Player_Pitching_ALL2$bbref_id[i])
    
  }
}


Pitcher_splits = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "pitching_splits") == T)]), full_join)
rm(list = ls()[which(grepl(ls(), pattern = "pitching_splits") == T)])
```

```{r old splits code, eval = F, include = F, message = F, warning = F, echo = F}
# Pitcher_splits %>%
#   dplyr::filter(Year == 2017) %>%
#   dplyr::mutate(key_bbref = bbref_id) %>%
#   left_join(CHAD_LU, by = "key_bbref", suffix = c(".x", ".y")) %>%
#   dplyr::select(-contains("key"), -contains("name_"), -contains("mlb")) %>%
#   dplyr::group_by(Split) %>%
#   dplyr::summarize(across(where(is.numeric), mean, na.rm = T)) %>%
#   dplyr::rename_if(vars(is.numeric(.)), ~ paste0("lgAvg_",.)) %>%
#   dplyr::mutate(Year = lgAvg_Year, .before = 1) %>%
#   dplyr::select(-contains("_Year"))
```

```{r load splits environment, include = F, message = F, warning = F, echo = F}
#save.image("~/GitHub/Baseball/CVSL/2022/BR_envir_2.RData")
# load("~/GitHub/Baseball/CVSL/2022/BR_envir_2.RData")
```

Wrangle the splits data to add more player information

```{r group splits, eval = F, include = T, message = F, warning = F, echo = T}
## Get more player info, like the handedness of the pitcher
Pitcher_splits = Pitcher_splits %>%
  dplyr::mutate(across(where(is.numeric), as.character)) %>%
  dplyr::mutate(Year = as.double(Year)) %>%
  left_join(Player_Pitching_ALL2, by = c("bbref_id", "Year")) %>%
  dplyr::relocate(c(Year, Name, bbref_id, lastinit, Throws, Age, Tm, Traded, Split), .before = 1) %>%
  dplyr::rename_at(vars(contains(".x")), ~ str_remove(., ".x")) %>%
  dplyr::select(c(1:36))

## Group by platoon year to derive lg avg splits
LgAvg_Pitcher_Splits = Pitcher_splits %>%
  dplyr::mutate(across(c(10:36), as.numeric)) %>%
  dplyr::group_by(Year, Throws, Split) %>%
  dplyr::summarize(across(where(is.numeric), mean, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::filter(!is.na(Throws)) %>%
  dplyr::mutate(bbref_id = "LgAvg", .before = 1) %>%
  dplyr::mutate(across(c("BA", "OBP", "SLG", "OPS", "BAbip", "tOPS+", "sOPS+"),
                       round, 3)) %>%
  dplyr::mutate(across(c("SO/W"), round, 2)) %>%
  dplyr::mutate(across(c("G", "PA", "AB", "R", "H", "2B", "3B", "HR", "SB", "CS",
                         "BB", "SO", "TB", "GDP", "HBP", "SH", "SF", "IBB", "ROE",
                         "tOPS+", "sOPS+", "Traded"), round, 0)) %>%
  dplyr::arrange(desc(`sOPS+`))

## Add the Lg Avg back to the splits
Pitcher_splits = Pitcher_splits %>%
  dplyr::mutate(across(c(10:36), as.numeric)) %>%
  full_join(LgAvg_Pitcher_Splits) %>%
  dplyr::arrange(OPS)

## Add searchable pitcher name, FG id
Pitcher_splits = Pitcher_splits %>%
  dplyr::rename(key_bbref = bbref_id) %>%
  left_join(CHAD_LU, by = c("key_bbref")) %>%
  dplyr::rename(Name = Name.y) %>%
  dplyr::select(-Name.x) %>%
  dplyr::relocate(Name, .before = 2) %>%
  dplyr::rename(bbref_id = key_bbref,
                playerid = key_fangraphs) %>%
  dplyr::relocate(playerid, .after = "lastinit") %>%
  dplyr::select(-contains("name_"), -contains("key"), -contains("mlb"))


## Group by platoon year to derive lg avg splits
LgAvg_Hitter_splits = Hitter_splits %>%
  dplyr::mutate(key_bbref = bbref_id) %>%
  dplyr::left_join(CHAD_LU, by = c("key_bbref")) %>%
  dplyr::rename(Name = Name.x) %>%
  dplyr::select(-contains("key"), -contains("name_"), -contains("mlb"), -contains(".y")) %>%
  dplyr::group_by(Year, Bats, Split) %>%
  dplyr::summarize(across(where(is.numeric), mean, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(bbref_id = "LgAvg", .after = 1) %>%
  dplyr::mutate(lastinit = "LgAvg", .after = 2) %>%
  dplyr::mutate(playerid = "LgAvg", .after = 3) %>%
  dplyr::relocate(c(Bats, Split), .after = "playerid") %>%
  dplyr::mutate(across(c("BA", "OBP", "SLG", "OPS", "BAbip", "tOPS+", "sOPS+"), round, 3)) %>%
  dplyr::mutate(across(c("Traded", "G", "PA", "AB", "R", "H", "2B", "3B", "HR", "RBI",
                         "SB", "CS", "BB", "SO", "TB", "GDP", "HBP", "SH", "SF", "IBB",
                         "ROE", "tOPS+", "sOPS+"), round, 0))

## Add the lg avg back to the splits
Hitter_splits = Hitter_splits %>%
  dplyr::mutate(key_bbref = bbref_id) %>%
  left_join(CHAD_LU, by = "key_bbref") %>%
  dplyr::mutate(playerid = as.character(key_fangraphs), .after = "lastinit") %>%
  full_join(LgAvg_Hitter_splits) %>%
  dplyr::mutate(Name = Name.y, .after = 1) %>%
  dplyr::select(-contains("key"), -contains("name_"), -contains("mlb"), -contains(".x"), -contains(".y")) %>%
  dplyr::arrange(desc(`sOPS+`))
```

```{r Add FG IDs, eval = F, include = F, message = F, warning = F, echo = F}

## Add FG IDs to the aggregated hitter stats
Player_Batting = Player_Batting_ALL2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Michael") &
                                       grepl(Name, pattern = "Harris") &
                                       grepl(Name, pattern = "II") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Michael Harris")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Bobby") &
                                       grepl(Name, pattern = "Witt") &
                                       grepl(Name, pattern = "Jr") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Bobby Witt") &
                                                       name_suffix == "Jr.") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Matt") &
                                       grepl(Name, pattern = "Reynolds") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Matt Reynolds") &
                                                       name_given == "Matthew William") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Luis") &
                                       grepl(Name, pattern = "Alexander") &
                                       grepl(Name, pattern = "Basabe") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Alexander Basabe")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     TRUE ~ bbref_id),
                key_bbref = bbref_id,
                lastinit = str_extract(string = bbref_id, pattern = "[a-z]{1}")) %>%
  left_join(CHAD_LU, by = "key_bbref") %>%
  dplyr::mutate(playerid = key_fangraphs, .after = 3) %>%
  dplyr::rename(Name = Name.x,
                bWAR = WAR) %>%
  dplyr::relocate(Year, .before = 1) %>%
  dplyr::relocate(bbref_id, .before = "lastinit") %>%
  dplyr::select(-contains("key"), -contains("name_"), -contains("mlb"), -contains(".y"))

## Add FG IDs to the aggregated pitcher stats
Player_Pitching = Player_Pitching_ALL2 %>%
  dplyr::mutate(key_bbref = bbref_id) %>%
  left_join(CHAD_LU, by = "key_bbref") %>%
  dplyr::mutate(playerid = key_fangraphs, .after = 3) %>%
  dplyr::rename(Name = Name.x,
                bWAR = WAR) %>%
  dplyr::relocate(Year, .before = 1) %>%
  dplyr::relocate(bbref_id, .before = "lastinit") %>%
  dplyr::select(-contains("key"), -contains("name_"), -contains("mlb"), -contains(".y"))
```

```{r import saved environment, include = F, message = F, warning = F, echo = F}
# load("~/GitHub/Baseball/CVSL/2022/BR_envir_2.RData")
```

```{r clean the GE, eval = F, include = F, message = F, warning = F, echo = F}
rm(list = ls()[which(grepl(ls(), pattern = "Changing|df|LgAvg|Player_(.+?)_ALL$|Team_") == T)])

Player_Batting = Player_Batting_ALL2
rm(Player_Batting_ALL2)

Player_Pitching = Player_Pitching_ALL2
rm(Player_Pitching_ALL2)
```

# Processed DFs {.tabset .tabset-pills .tabset-fade}

Show the resulting data frames:

## Hitters' splits

```{r Hitter splits DF DT, include = T, message = F, warning = F, echo = F}
DT::datatable(Hitter_splits)
```

## Pitchers' splits

```{r Pitcher splits DF DT, include = T, message = F, warning = F, echo = F}
DT::datatable(Pitcher_splits)
```

## Aggregated hitters' data

```{r Aggregate Hitter DF DT, include = T, message = F, warning = F, echo = F}
DT::datatable(Player_Batting)
```

## Aggregated pitchers' data

```{r Aggregate Pitcher DF DT, include = T, message = F, warning = F, echo = F}
DT::datatable(Player_Pitching)
```

# Integrate CVSL Rosters and Rules {.tabset .tabset-pills .tabset-fade}

## Import Previous CVSL Rosters Environment

```{r Import CVSL Roster Environment, include = T, message = F, warning = F, echo = T}
load("~/GitHub/Baseball/CVSL/2022/CVSLenv.RData")
```

```{r Import Draft history, include = F, message = F, warning = F, echo = F}
path.to.drafts = "~/GitHub/Baseball/CVSL/2022"
files = list.files(path.to.drafts)

files = files[grepl(files, pattern = "Draft ([0-9]){4}.csv$")]

for ( i in 1:length(files) ) {
  as.data.frame(
    assign(
      gsub(gsub(files[],
                pattern = " ",
                replacement = "_"),
           pattern = ".csv",
           replacement = "",
           fixed = T)[i], read.csv(file = paste(path.to.drafts, "\\/", files[i], sep = "")))
  )
}

# gsub(".csv", "", files[], fixed = TRUE)[i], read.csv(file = paste(path.to.drafts, "\\/", files[i], sep = "")))
```

```{r Clean Draft results dfs, eval = T, include = F, message = F, warning = F, echo = F}
# Clean the 2019 dataframe ----
colnames(CVSL_Draft_2019) = CVSL_Draft_2019[1,]

  ## Remove dollar signs and co-erce salaries as integers for math ops
for ( i in seq(2, ncol((CVSL_Draft_2019)), 2) ){
  CVSL_Draft_2019[,i] = gsub(CVSL_Draft_2019[,i], pattern = "\\$", replacement ="")
  CVSL_Draft_2019[,i] = as.integer(CVSL_Draft_2019[,i])
}
  ## Re-name the salary columns
colnames(CVSL_Draft_2019)[seq(2, ncol((CVSL_Draft_2019)), 2)] = "Salary"
CVSL_Draft_2019 = CVSL_Draft_2019[ -1, ]

  ## Re-arrange the dataframe to put all players into a column
dummy = as.data.frame(
  cbind(c(CVSL_Draft_2019[,1], CVSL_Draft_2019[,3], CVSL_Draft_2019[,5], CVSL_Draft_2019[,7], CVSL_Draft_2019[,9],
        CVSL_Draft_2019[,11], CVSL_Draft_2019[,13], CVSL_Draft_2019[,15], CVSL_Draft_2019[,17], CVSL_Draft_2019[,19]))
)

colnames(dummy) = "Name"

dummy = dummy %>%
  dplyr::mutate(Salary = 0, ## Create a second column of integers for Salaries
                CVSLTeam = "", ## Create a third column of strings for CVSL team id
                Year = 2019) ## Create a fourth column of integers of the year

  ## Replace the second column with the players' auction values
    ## remove NA rows
      ## add the teams that drafted each player
CVSL_Draft_2019 = dummy %>%
  dplyr::mutate(Salary = cbind(c(CVSL_Draft_2019[,2],
                                 CVSL_Draft_2019[,4],
                                 CVSL_Draft_2019[,6],
                                 CVSL_Draft_2019[,8],
                                 CVSL_Draft_2019[,10],
                                 CVSL_Draft_2019[,12],
                                 CVSL_Draft_2019[,14],
                                 CVSL_Draft_2019[,16],
                                 CVSL_Draft_2019[,18],
                                 CVSL_Draft_2019[,20]))
  ) %>%
  dplyr::filter(!is.na(Salary)) %>%
  dplyr::mutate(CVSLTeam = case_when(Name %in% CVSL_Draft_2019$`Golden Bears` &
                                       Name != "" ~ "Golden Bears",
                                     Name %in% CVSL_Draft_2019$Phillies &
                                       Name != "" ~ "Phillies",
                                     Name %in% CVSL_Draft_2019$Nuggets &
                                       Name != "" ~ "Nuggets",
                                     Name %in% CVSL_Draft_2019$Cattlemen &
                                       Name != "" ~ "Cattlemen",
                                     Name %in% CVSL_Draft_2019$Bison &
                                       Name != "" ~ "Bison",
                                     Name %in% CVSL_Draft_2019$Arsenal &
                                       Name != "" ~ "Arsenal",
                                     Name %in% CVSL_Draft_2019$Tamales &
                                       Name != "" ~ "Tamales",
                                     Name %in% CVSL_Draft_2019$Matadors &
                                       Name != "" ~ "Matadors",
                                     Name %in% CVSL_Draft_2019$Dodgers &
                                       Name != "" ~ "Dodgers",
                                     Name %in% CVSL_Draft_2019$Ducks &
                                       Name != "" ~ "Ducks"))
rm(dummy)

# Clean the 2020 df ----

  ## Remove dollar signs and co-erce salaries as integers for math ops
for ( i in seq(2, ncol((CVSL_Draft_2020)), 2) ){
  CVSL_Draft_2020[,i] = gsub(CVSL_Draft_2020[,i], pattern = "\\$", replacement ="")
  CVSL_Draft_2020[,i] = as.integer(CVSL_Draft_2020[,i])
}
  ## Re-name the salary columns
colnames(CVSL_Draft_2020)[seq(2, ncol((CVSL_Draft_2020)), 2)] = "Salary"
  ## Re-name the Team columns
colnames(CVSL_Draft_2020)[seq(1, ncol(CVSL_Draft_2020), 2)] = CVSL_Draft_2020[ 1, seq(1, ncol(CVSL_Draft_2020), 2)]
  ## remove the first row
CVSL_Draft_2020 = CVSL_Draft_2020[ -1, ]

  ## Re-arrange the dataframe to put all players into a column
dummy = as.data.frame(
  cbind(c(CVSL_Draft_2020[,1], CVSL_Draft_2020[,3], CVSL_Draft_2020[,5], CVSL_Draft_2020[,7], CVSL_Draft_2020[,9],
          CVSL_Draft_2020[,11], CVSL_Draft_2020[,13], CVSL_Draft_2020[,15], CVSL_Draft_2020[,17], CVSL_Draft_2020[,19]))
)

colnames(dummy) = "Name"

dummy = dummy %>%
  dplyr::mutate(Salary = 0, ## Create a second column of integers for Salaries
                CVSLTeam = "", ## Create a third column of strings for CVSL team id
                Year = 2020) ## Create a fourth column of integers of the year

CVSL_Draft_2020 = dummy %>%
  dplyr::mutate(Salary = cbind(c(CVSL_Draft_2020[,2],
                                 CVSL_Draft_2020[,4],
                                 CVSL_Draft_2020[,6],
                                 CVSL_Draft_2020[,8],
                                 CVSL_Draft_2020[,10],
                                 CVSL_Draft_2020[,12],
                                 CVSL_Draft_2020[,14],
                                 CVSL_Draft_2020[,16],
                                 CVSL_Draft_2020[,18],
                                 CVSL_Draft_2020[,20]))) %>%
  dplyr::filter(!is.na(Salary)) %>%
  dplyr::mutate(CVSLTeam = case_when(Name %in% CVSL_Draft_2020$Phillies &
                                       Name != "" ~ "Phillies",
                                     Name %in% CVSL_Draft_2020$Ducks &
                                       Name != "" ~ "Ducks",
                                     Name %in% CVSL_Draft_2020$Bison &
                                       Name != "" ~ "Bison",
                                     Name %in% CVSL_Draft_2020$Dodgers &
                                       Name != "" ~ "Dodgers",
                                     Name %in% CVSL_Draft_2020$Bears &
                                       Name != "" ~ "Bears",
                                     Name %in% CVSL_Draft_2020$Matadors &
                                       Name != "" ~ "Matadors",
                                     Name %in% CVSL_Draft_2020$Cattlemen &
                                       Name != "" ~ "Cattlemen",
                                     Name %in% CVSL_Draft_2020$Nuggets &
                                       Name != "" ~ "Nuggets",
                                     Name %in% CVSL_Draft_2020$Copperheads &
                                       Name != "" ~ "Copperheads",
                                     Name %in% CVSL_Draft_2020$Tamales &
                                       Name != "" ~ "Tamales"))
rm(dummy)

    # Clean the 2021 dataframe ----
  ## Remove the first 4 rows and the extra columns
CVSL_Draft_2021 = CVSL_Draft_2021[ -c(1:4), -c(seq(2, ncol(CVSL_Draft_2021), 2)) ]

  ## Remove the dollar signs and co-erce salaries as integers for math ops
for ( i in seq(2, ncol((CVSL_Draft_2021)), 2) ){
  CVSL_Draft_2021[,i] = gsub(CVSL_Draft_2021[,i], pattern = "\\$", replacement ="")
  CVSL_Draft_2021[,i] = as.integer(CVSL_Draft_2021[,i])
}
  ## Re-name the salary columns
colnames(CVSL_Draft_2021)[seq(2, ncol((CVSL_Draft_2021)), 2)] = "Salary"
rownames(CVSL_Draft_2021) = NULL

  ## Re-arrange the dataframe to put all players into a column
dummy = as.data.frame(
  cbind(c(CVSL_Draft_2021[,1], CVSL_Draft_2021[,3], CVSL_Draft_2021[,5], CVSL_Draft_2021[,7], CVSL_Draft_2021[,9],
          CVSL_Draft_2021[,11], CVSL_Draft_2021[,13], CVSL_Draft_2021[,15], CVSL_Draft_2021[,17], CVSL_Draft_2021[,19]))
)

colnames(dummy)[1] = "Name"

dummy = dummy %>%
  dplyr::mutate(Salary = 0, ## Create a second column of integers for Salaries
                CVSLTeam = "", ## Create a third column of strings for CVSL team id
                Year = 2021) ## Create a fourth column of integers of the year

CVSL_Draft_2021 = dummy %>%
  dplyr::mutate(Salary = cbind(c(CVSL_Draft_2021[,2],
                                 CVSL_Draft_2021[,4],
                                 CVSL_Draft_2021[,6],
                                 CVSL_Draft_2021[,8],
                                 CVSL_Draft_2021[,10],
                                 CVSL_Draft_2021[,12],
                                 CVSL_Draft_2021[,14],
                                 CVSL_Draft_2021[,16],
                                 CVSL_Draft_2021[,18],
                                 CVSL_Draft_2021[,20]))) %>%
  dplyr::filter(!is.na(Salary)) %>%
  dplyr::mutate(CVSLTeam = case_when(Name %in% CVSL_Draft_2021$Phillies &
                                       Name != "" ~ "Phillies",
                                     Name %in% CVSL_Draft_2021$Ducks &
                                       Name != "" ~ "Ducks",
                                     Name %in% CVSL_Draft_2021$Bison &
                                       Name != "" ~ "Bison",
                                     Name %in% CVSL_Draft_2021$Dodgers &
                                       Name != "" ~ "Dodgers",
                                     Name %in% CVSL_Draft_2021$Renegades &
                                       Name != "" ~ "Renegades",
                                     Name %in% CVSL_Draft_2021$Matadors &
                                       Name != "" ~ "Matadors",
                                     Name %in% CVSL_Draft_2021$Cattlemen &
                                       Name != "" ~ "Cattlemen",
                                     Name %in% CVSL_Draft_2021$Nuggets &
                                       Name != "" ~ "Nuggets",
                                     Name %in% CVSL_Draft_2021$Copperheads &
                                       Name != "" ~ "Copperheads",
                                     Name %in% CVSL_Draft_2021$Tamales &
                                       Name != "" ~ "Tamales"))
rm(dummy)

# Clean the 2022 df ----
  ## Remove the first 4 rows and the extra columns
CVSL_Draft_2022 = CVSL_Draft_2022[ -c(1:4), -c(seq(7, ncol(CVSL_Draft_2022), 8)) ]

dummy = CVSL_Draft_2022 %>%
  dplyr::select(-contains("X"), -contains("Players")) %>%
  dplyr::slice(-c(1:4)) %>%
  dplyr::mutate(across(contains("Cap"), ~ gsub(., pattern = "\\$", replacement = "")))

CVSL_Draft_2022 = pivot_longer(dummy, cols = everything()) %>%
  dplyr::select(value, name) %>%
  dplyr::rename(CVSLTeam = name) %>%
  dplyr::rename(Name = value) %>%
  dplyr::mutate(Salary = case_when(grepl(Name, pattern = "[0-9]") ~ as.numeric(Name),
                                   TRUE ~ NA_real_), .after = 1) %>%
  dplyr::mutate(Salary = case_when(is.na(Salary) ~ lead(Salary),
                                   TRUE ~ NA_real_),
                Year = 2022) %>%
  dplyr::filter(!is.na(Salary)) %>%
  dplyr::arrange(CVSLTeam)

rm(dummy)


# Clean the 2023 df ----
CVSL_Draft_2023 = read_csv("C:/Users/Erik/Desktop/BoxCopy/Strato/2023/CVSL Draft 2023.csv")
CVSL_Draft_2023 = CVSL_Draft_2023[ -c(1:4), -c(seq(7, 63, 7)) ] ## remove excess columns; Cattlemen doesn't have one at eand

dummy = CVSL_Draft_2023 %>%
  dplyr::select(-c(seq(from = 3, to = ncol(CVSL_Draft_2023), by = 6))) ## remove column placeholders

dummy = dummy %>%
  dplyr::select(-c(seq(from = 1, to = ncol(dummy), by = 5))) %>% ## remove player_drafted n column
  dplyr::select(-contains("X"), -contains("Players")) %>% ## remove "players needed" column
  dplyr::mutate(across(contains("Cap"), ~ gsub(., pattern = "\\$", replacement = ""))) %>% ## strip the dollar sign
  dplyr::select(-c(seq(2, 30, 3))) ## remove the "On-40 Man?" column

CVSL_Draft_2023 = pivot_longer(dummy, cols = everything()) %>%
  dplyr::select(value, name) %>%
  dplyr::rename(CVSLTeam = name) %>%
  dplyr::rename(Name = value) %>%
  dplyr::mutate(Salary = case_when(grepl(Name, pattern = "[0-9]") ~ as.numeric(Name),
                                   TRUE ~ NA_real_), .after = 1) %>%
  dplyr::mutate(Salary = case_when(is.na(Salary) ~ lead(Salary),
                                   TRUE ~ NA_real_),
                Year = 2023) %>%
  dplyr::filter(!is.na(Salary)) %>%
  dplyr::arrange(CVSLTeam) %>%
  dplyr::mutate(Name = sub("^(.*), (.*)$", "\\2, \\1", Name),
                Name = gsub(x = Name, pattern = ",", replacement = ""))

rm(dummy)

DRAFTS = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Draft") == T) ]), full_join)
rm(list = ls()[which(grepl(ls(), pattern = "_Draft") == T)])
```

```{r clean the environment, include = T, message = F, warning = F, echo = F}
# rm(list = ls()[which(grepl(ls(),
#                            pattern = "total|col_names|CVSL_LH|CVSL_RH_|arb_players|bid_players|FG|eligible|dashed_|players|Pitchers_|Hitters|DRAFT|dummy|BID_UNI|Traded|vL|vR|listy|_Standard") == T)])

rm(list = ls()[which(grepl(ls(), pattern = "CHAD_LU|DRAFTS|_splits|Player_|%notin%|fn|MASTER") == F)])
```

```{r correct draft ids pt 1, include = T, message = F, warning = F, echo = F}
 ## Add IDs
DRAFTS2 = DRAFTS %>%
  dplyr::distinct() %>%
  dplyr::filter(Name != "") %>%
  left_join(CHAD_LU, by = "Name") %>%
  dplyr::mutate(bbref_id = key_bbref,
                playerid = key_fangraphs) %>%
  dplyr::select(-contains("name_"), -contains("key"), -contains("mlb")) %>%
  dplyr::filter(CVSLTeam != "Starting.Cap.2")

## Add missing bbref ids pt 1
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Gorkys") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Gorkys")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ronald Guzman") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ronald Guz")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Vidal N") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Vidal N")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "German M") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Germ") &
                                                       grepl(Name, pattern = "M")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Michael A. Taylor") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Michael Taylor") &
                                                       name_given == "Michael Anthony") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Adrian Beltre") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Adri") &
                                                       grepl(Name, pattern = "Beltr")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Lourdes Gurriel, Jr.") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Lourdes")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Anibal") &
                                       grepl(Name, pattern = "Sanchez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "bal S")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Aledmys Diaz") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Aledmys")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jesus Sucre") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Sucre")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end part 1 of corrections
  )
```


```{r correct draft ids pt 2, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Kiner") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Kiner-")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Hech") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Hechavar")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Domingo German") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Domingo Germ")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Edwin Encarnacion") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Edwin Encar")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Victor Arano") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Arano"))  %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jose Briceno") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jos") &
                                                       grepl(Name, pattern = "Brice")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Venters") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Venters")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Britton") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Zack Britton")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Pedro Baez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Pedro B") &
                                                       name_given == "Pedro Alberys") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jose LeClerc") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Leclerc")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end part 2 corrections
  )
```

```{r correct draft ids pt 3, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Jose Alverado") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jos") &
                                                       grepl(Name, pattern = "Alvarado")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Yairo") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Yairo")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Seranthony Dominguez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Seranthony")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ponce") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Daniel Ponce")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Sandy Leon") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Sandy Le")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Leonys Martin") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Leonys Mart")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Lou Trevino") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Trivino")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Oliver Perez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Oliver P")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "eck Rodr") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Dereck")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Elisier Hernandez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Elieser")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt. 3 corrections
  )
```

```{r correct draft ids pt 4, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Elieser Hernandez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Elieser")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "W. Suarez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Wander Suero")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Man Choi") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Man Choi")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ramon Laureano") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ram") &
                                                       grepl(Name, pattern = "Laureano")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Michael Tauchman") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Tauchman")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Yandy") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Yandy")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Carlos Carasco") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Carlos Carrasco")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Emilio Pagan") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Emilio Pag")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Roberto Perez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Roberto P") &
                                                       name_given == "Roberto Andres") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Yoan Lopez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Yoan L")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt 4 corrections
  )
```

```{r correct draft ids pt 5, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Adam Civale") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Civale")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Joyce") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Matt Joyce")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Yimi Garcia") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Yimi G")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Manaea") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Manaea")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jackie Bradley") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jackie Bradley")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Adolis Garcia") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Adolis") &
                                                       grepl(Name, pattern = "Garc")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Gio Urshella") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Urshela")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "S Chrichton") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Crichton")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jarlin Garcia") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jarl") &
                                                       grepl(Name, pattern = "Garc")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Travis Webb") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Tyler Webb")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt 5 corrections
  )
```

```{r correct draft ids pt 6, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Oscar Mercado") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "scar Mercado")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Brock Holt") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Brock Holt")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Todd Frazier") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Todd Frazier")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Michael Wacha") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Michael Wacha")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Robinson Cano") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Robinson Can") &
                                                       name_given == "Robinson Jose") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "John Gant") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "John Gant")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Joely Rodriguez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Joely")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Genesis Cabrera") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern =  "sis Cab")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Mauricio Dubon") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Mauricio D")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Carson Kelly") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Carson Kelly")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt. 6 corrections
  )
```

```{r correct draft ids pt 7, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "John Merryweather") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Merryweather")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Pollock") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Pollock")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Eovaldi") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Eovaldi")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Josh Fleming") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Josh Fleming")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jasson") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jasson")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Andres Gimenez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "s Gim") &
                                                       grepl(name_given, pattern = "s Alf")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Andres Giminez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "s Gim") &
                                                       grepl(name_given, pattern = "s Alf")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Victor Gonzalez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Victor Gonz")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Pablo Lopez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Pablo L")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Taylor Ward") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Taylor Ward")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt 7 corrections
  )
```

```{r correct draft ids pt 8, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Adam Ott") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Adam Ott")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Daniel Castano") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Daniel Castano")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Joe Panik") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Panik")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Darren O'Day") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Darren O'Day")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Josh Donaldson") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Josh Donaldson")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Trevor Rosenthal") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Trevor Rosenthal")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "David Dahl") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "David Dahl")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Mike Brosseau") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Mike Brosseau")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Segura") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jean Segura")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jazz") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jazz")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt. 8 corrections
  )
```

```{r correct draft ids pt 9, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Christian V") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Christian V") &
                                                       name_given == "Christian Rafael") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Matt Olson") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Matt Olson")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Martin Perez") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "perezma02") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Alex Avila") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Alex Avila")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Andriese") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Andriese")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Josh Fuentes") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Joshua Fuentes")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Giancarlo Stanton") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Giancarlo Stanton")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Leodys Taveras") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Leody Taveras")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ryan Jeffers") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ryan Jeffers")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jay Bruce") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jay Bruce")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt 9 corrections
  )
```

```{r correct draft ids pt 10, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Teoscar") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Teosc")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Caleb Th") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Caleb Thielbar")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jose Ramirez") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "ramirjo01") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Brusdar") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Brusdar")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Deivi Gar") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Deivi Gar")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jesus Aguilar") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "s Aguilar")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Riley Smith") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Riley Smith")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Nestor Cort") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Nestor Cort")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Bryan de la Cruz") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Bryan De La Cruz")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Elias Diaz") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Elias D")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt 10 corrections
  )
```

```{r correct draft ids pt 11, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Noe Ramirez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "No") &
                                                       grepl(Name, pattern = "Ramirez")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "LaMonte") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "LaMonte Wade")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Richard Rod") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Richard Rod")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Andy Ibanez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Andy Ib")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Craig Stammen") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Craig Stammen")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Marcel Ozuna") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Marcell Ozuna")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ian Kennedy") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ian Kennedy")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ryan Zimmerman") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ryan Zimmerman")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Pavin Smith") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Pavin Smith")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt 11 corrections
  )
```

```{r correct draft ids pt 12, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Andres") &
                                       grepl(Name, pattern = "Gim") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Andr") &
                                                       grepl(Name, pattern = "s Gim")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Beatty") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Baty")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ha-seo") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ha-seo")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Harold") &
                                       grepl(Name, pattern = "Ram") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Harold Ram")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jose Iglesias") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jos") &
                                                       grepl(Name, pattern = "Iglesias")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jose") &
                                       grepl(Name, pattern = "Quintana") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Quintana") &
                                                       grepl(Name, pattern = "Jos")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Gary") &
                                       grepl(Name, pattern = "Sanchez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Gary S") &
                                                       grepl(Name, pattern = "nchez")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Nick Castellanos") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern  = "Nick Castellanos")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "John Berti") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Berti")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Sears") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "JP Sears")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt 12 corrections
  )
```

```{r correct draft ids pt 13, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Quijada") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Quijada")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Zack Jackson") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Zach Jackson") &
                                                       name_given == "Zachary Garrett") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Herrerra") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jose Herrera") &
                                                       name_given == "Jose Gregorio") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jose Azocar") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jos") &
                                                       grepl(Name, pattern = "Azocar")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Yuri") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Eury P") &
                                                       name_given == "Eury Rafael") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Albies") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ozzie Albies")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Dany Jim") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Dany Jim")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Kyle Fin") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Kyle Fin")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Kike Hernandez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Enrique Hern")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Carlos Estevez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Carlos Est")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id) # end pt 13 corrections
  )
```

```{r correct draft ids pt 14, include = T, message = F, warning = F, echo = F}
DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Adrian Morejon") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "n morej")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Carlos Rodon") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Carlos Rod") &
                                                       name_given == "Carlos Antonio") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jose Alvarado") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jos") &
                                                       grepl(Name, pattern = "Alvarado")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jonathan Loaisiga") ~ CHAD_LU %>%
                                       dplyr::filter(name_given == "Jonathan Stanley") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jose Suarez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jos") &
                                                       grepl(Name, pattern = "rez") &
                                                       grepl(Name, pattern = "Su")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Michael King") ~ CHAD_LU %>%
                                       dplyr::filter(name_given == "Michael McRae") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ranger") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ranger Su")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id)
                ) %>%
  dplyr::filter(bbref_id != "rodried01") %>%
  dplyr::filter(bbref_id != "rodried01") %>%
  dplyr::filter(bbref_id != "castidi02") %>%
  dplyr::filter(bbref_id != "schuljo03")

DRAFTS = DRAFTS2
rm(DRAFTS2)
```

```{r add fg ids and correct names, include = T, message = F, warning = F, echo = F}

DRAFTS = DRAFTS %>%
  dplyr::mutate(key_bbref = bbref_id) %>%
  inner_join(CHAD_LU, by = "key_bbref") %>%
  dplyr::select(-playerid) %>%
  dplyr::rename(playerid = key_fangraphs) %>%
  dplyr::rename(Name = Name.y) %>%
  dplyr::select(-contains("key"), -contains(".x"),
                -contains(".y"), -contains("name_"),
                -contains("mlb")) %>%
  dplyr::relocate(Name, .before = 1)

## Correct spellings or players with improper baseball reference ids
DRAFTS = DRAFTS %>%
    dplyr::distinct() %>%
    dplyr::mutate(key_bbref = bbref_id) %>%
    left_join(CHAD_LU, by = c("key_bbref")) %>%
    dplyr::filter(!grepl(bbref_id, pattern = "anderbr(02|03)")) %>%
    dplyr::filter(!grepl(bbref_id, pattern = "castidi01")) %>%
    dplyr::filter(!grepl(bbref_id, pattern = "schuljo03")) %>%
    dplyr::filter(!(grepl(CVSLTeam, pattern = "Ducks") & name_given == "William Michael")) %>%
    dplyr::filter(!(grepl(CVSLTeam, pattern = "Ducks") & key_bbref == "cruzne01")) %>%
    dplyr::filter(!(grepl(CVSLTeam, pattern = "Ducks") & key_bbref == "perdolu01")) %>% 
    dplyr::filter(!(grepl(CVSLTeam, pattern = "Cattlemen") & key_bbref == "mortoch01")) %>%
    dplyr::filter(!(grepl(CVSLTeam, pattern = "Cattlemen") & key_bbref == "hamilbi01")) %>%
    dplyr::filter(!grepl(bbref_id, pattern = "kellyjo(03|04)")) %>%
    dplyr::mutate(Name = Name.y, .before = 1) %>%
    dplyr::select(-Name.x, -playerid, -contains("mlb"), -contains("name_"), -contains("key_m"), -contains("key_b"), -Name.y, -key_retro)

```

```{r save universe environment, eval = F, include = F, message = F, warning = F, echo = F}
# save.image("~/GitHub/Baseball/CVSL/2022/CompleteUniversesAndLeaderboardsEnv.RData")
```

## Plot Some Draft Results

Scatter plot of some previous draft results

```{r Join Draft history with stats, include = T, message = F, warning = F, echo = F, render = T, fig.height = 8, fig.width = 11}
DRAFTS2 = DRAFTS %>%
  dplyr::mutate(labs = "") %>%
  dplyr::arrange(desc(Salary))

DRAFTS2 = DRAFTS2 %>%
  dplyr::mutate(labs = case_when(Salary >= 35 ~ paste(Name, Year, sep = " "),
                                 TRUE ~ ""))


DRAFTS2 %>%
  dplyr::mutate(Year2 = Year - 1, .after = 3) %>%
  dplyr::select(-Year) %>%
  dplyr::mutate(Year = Year2) %>%
  dplyr::select(-Year2) %>%
  dplyr::filter(Year < 2022) %>%
  left_join(Player_Batting, by = c("bbref_id", "Year")) %>%
  dplyr::filter(!is.na(Name.y)) %>%
  dplyr::rename(Name = Name.x) %>%
  dplyr::select(-Name.y) %>%
  dplyr::mutate(CVSLTeam = case_when(CVSLTeam == "Bears" ~ "Renegades",
                                     CVSLTeam == "Copperheads" ~ "Arsenal",
                                     CVSLTeam == "Golden Bears" ~ "Renegades",
                                     CVSLTeam == "Tamales" ~ "Wombats",
                                     CVSLTeam == "Dodgers" ~ "Twins",
                                     TRUE ~ CVSLTeam),
                Rbat = as.double(Rbat)) %>%
  dplyr::mutate(`CVSL Draft` = paste("CVSL Draft", Year + 1, sep = " ")) %>%
  dplyr::group_by(`CVSL Draft`) %>%
  ggplot() +
  geom_point(aes(x = Rbat,
                 y = Salary,
                 size = 2.2,
                 alpha = 0.4,
                 color = CVSLTeam,
                 label = labs)) +
  geom_smooth(aes(x = Rbat,
                  y = Salary), method = "gam", se = F)+
  facet_wrap(~`CVSL Draft`)+
  labs(title = "CVSL Auctions, Hitters (2019-2023)", x = "'RBat'", y = "Salary ($)")+
  guides(alpha = "none")+
  guides(size = "none")+
  theme_bw()+
  theme(plot.title = element_text(hjust = 0.5, size = 12)) +
  scale_color_manual(values = c("darkgoldenrod", "chocolate", "black",
                                "forestgreen", "firebrick", "orange", "gray48",
                                "red", "navy", "skyblue")) +
  geom_text_repel(aes(x = Rbat, y = Salary, label = labs), color = "black", size = 3, max.overlaps = Inf, box.padding = 0.5)
```


## Eligible MLB Teams

The MLB teams from which CVSL Managers can draft players

```{r CVSL Eligible Teams, eval = T, include = T, message = F, warning = F, echo = T}
CVSL_universe = c("SFG", "SDP", "LAD", "ARI", "COL",
                   "OAK", "TEX", "LAA",
                   "MIN", "CLE",
                   "STL",
                   "PHI", "NYM", "MIA", "ATL", "WSN",
                   "NYY", "TBR", "TOR", "BOS")
```

## Filter by "Service Time" Criteria

Filter hitters by:

+ `C`s need **>= 100 ABs** to be eligible to catch in CVSL games
+ all other hitters need **>= 175 ABs** to be eligible to play in CVSL games

Filter pitchers by:

+ `SP`s need **>= 8 starts (GS)** *AND* **>= 30 IP** to be eligible to start in CVSL games
+ `RP`s need **>= 30 IP** to be eligible to pitch in CVSL games

+ **code below is filtered to include only 2023 MLB stats**

```{r Stats and splits by year, include = T, message = F, warning = F, echo = T}

eligible_hitters_2024 = Player_Batting %>%
  dplyr::filter(Year == 2023) %>%
  dplyr::mutate(AB = as.numeric(AB),
                eligible = case_when(AB < 100 ~ 0,
                                     grepl(Positions, pattern = "(C)") &
                                       AB >= 100 ~ 1,
                                     grepl(Positions, pattern = "1B") &
                                       AB >= 175 ~ 1,
                                     grepl(Positions, pattern = "2B") &
                                       AB >= 175 ~ 1,
                                     grepl(Positions, pattern = "3B") &
                                       AB >= 175 ~ 1,
                                     grepl(Positions, pattern = "SS") &
                                       AB >= 175 ~ 1,
                                     grepl(Positions, pattern = "LF") &
                                       AB >= 175 ~ 1,
                                     grepl(Positions, pattern = "(CF)") &
                                       AB >= 175 ~ 1,
                                     grepl(Positions, pattern = "RF") &
                                       AB >= 175 ~ 1,
                                     
                                     TRUE ~ 0), .after = 1) %>%
  dplyr::filter(eligible == 1) %>%
  dplyr::select(Name, bbref_id, Tm, Positions, AB) %>%
  dplyr::filter(Tm %in% CVSL_universe) %>%
  dplyr::distinct()


eligible_pitchers_2024 = Player_Pitching %>%
  dplyr::filter(Year == 2023) %>%
  dplyr::mutate(G = as.numeric(G),
                GS = as.numeric(GS),
                IP = as.numeric(IP),
                eligible = case_when(GS >= 8 &
                                       IP >= 30 ~ 1,
                                     IP >= 30 ~ 1,
                                     TRUE ~ 0), .after = 1) %>%
  dplyr::select(Name, bbref_id, Tm, eligible, G, GS, IP) %>%
  dplyr::filter(Tm %in% CVSL_universe) %>%
  dplyr::filter(eligible == 1) %>%
  dplyr::distinct()

```

Show hitter splits for **2024** (based on 2023 MLB stats)

```{r Show hitter splits, include = T, message = F, warning = F, echo = T}
Hitter_splits %>%
  dplyr::mutate(Bats = case_when(Bats == "S" &
                                   Split == "vs LHP" ~ "R",
                                 Bats == "S" &
                                   Split == "vs RHP" ~ "L",
                                 TRUE ~ Bats)) %>%
  dplyr::filter(Year == 2023) %>%
  dplyr::filter(bbref_id %in% eligible_hitters_2024$bbref_id) %>%
  dplyr::arrange(desc(`sOPS+`)) %>%
  dplyr::filter(Tm %in% CVSL_universe) %>%
  DT::datatable()
```







Show pitcher splits for **2024** (based on 2023 MLB stats)

```{r Show pitcher splits, include = T, message = F, warning = F, echo = T}
Pitcher_splits %>%
  dplyr::select(-contains(".y")) %>%
  dplyr::filter(Year == 2023) %>%
  dplyr::filter(bbref_id %in% eligible_pitchers_2024$bbref_id) %>%
  dplyr::arrange(`sOPS+`) %>%
  left_join(Player_Pitching, by = c("bbref_id", "Year")) %>%
  dplyr::rename_at(vars(contains(".x")), ~ str_remove(., ".x")) %>%
  dplyr::relocate(Tm, .after = "Year") %>%
  dplyr::select(-c(36:88)) %>%
  dplyr::filter(Tm %in% CVSL_universe) %>%
  dplyr::mutate(`BB%` = round(BB / PA, 3),
                `K%` = round(SO / PA, 3)) %>%
  dplyr::arrange(OBP) %>%
  DT::datatable()
```