---
title: "Tanking Data Wrangling"
author: "Erik Larsen"
date: "4/23/2022"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: true
    numbered_sections: true
    code_folding: hide
---

# Overview

This snippet was used in my article (currently under review) on [TheLeftyCatcher](https://www.theleftycatcher.com), where I compared and contrasted how `Jeff Luhnow` and `Theo Epstein` tanked to rebuild the `Chicago Cubs` and `Houston Astros`, beginning in ~2011 into World Series winners.

I acquired `MLB Free Agent` data, `MLB Amateur Draft` data, `International Signing` data, `MLB Standings` data, `MLB Payroll` data, and "`MLB Value`" data. I scraped or downloaded this data from multiple sites, including `Baseball Reference`, `ESPN`, and `Baseball Almanac`. It required some processing to compile and analyze with or without graphs.

Subsequent pieces and snippets will revolve around this data.

The functions used are sourced from (this)[] file.

# Environment Prep {.tabset .tabset-pills .tabset-fade}

Load packages and functions

## Load packages

```{r Load packages, include = T, warning = F, message = F, echo = T}
  ## Data wrangling; df re-arrangement, string manipulations
library(readr)
library(reshape2)
library(tidyverse)
library(stringr)
library(stringi)

  ## Web scraping
library(rvest)
library(XML)

  ## Plotting
library(ggplot2)
library(ggrepel)
library(GGally)
library(ggpubr)
library(plotly)

  ## Modeling
library(mgcv)
library(splines)

source("~/GitHub/Baseball/Tanking/Tanking Functions.R")
```

# Baseball Reference Standings Data {.tabset .tabset-pills .tabset-fade}

Import `Baseball Reference`'s `Standings` data over relevant years

## Scrape and Clean Baseball Reference Standings Data

```{r Scrape standings data from Baseball Reference, include = T, message = F, warning = F, echo = T}
  ## Loop through and import the standings from 2011-2021
for ( i in 11:21 ) {
  if (i %% 17 == 0 ) {
    
    Sys.sleep(60)
    
  } else {
    
    BR_STAND_IMPORT_fn(Year = i)
    
  }
}
  ## merge the dfs together
StandALL = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Standings") == TRUE)]), full_join)
  ## correct team name changes
StandALL = StandALL %>%
  dplyr::mutate(Tm = case_when(grepl(Tm, pattern = "Angels") ~ "Los Angeles Angels",
                               grepl(Tm, pattern = "Florida") ~ "Miami Marlins",
                               grepl(Tm, pattern = "Indians") ~ "Cleveland Guardians",
                               TRUE ~ Tm))
  ## remove the individual dfs
rm(list = ls()[which(grepl(ls(), pattern = "Standings") == T)])
```

# Baseball Reference Player Value Data {.tabset .tabset-pills .tabset-fade}

Import `BBRef`'s `player value` data, originally scraped from `BBRef`

## Import "player value" Data from `Baseball Reference`

Import the data from Git repo

```{r Import Player Value Data from BBRef, include = T, warning = F, message = F, echo = T}

# rm(list = ls()[which(grepl(ls(), pattern = "Player_Value") == T)])

for ( i in 11:21 ){
  if (i %% 17 == 0 ) {
    
      Sys.sleep(60)
    
    BR_PLAYER_VAL_IMPORT_fn(Year = i, Player_data_type = "batting")
    
    } else {
      
      BR_PLAYER_VAL_IMPORT_fn(Year = i, Player_data_type = "batting")
  
    }
}

for ( i in 11:21 ){
  if (i %% 17 == 0 ) {
    
      Sys.sleep(60)
    
    BR_PLAYER_VAL_IMPORT_fn(Year = i, Player_data_type = "pitching")
    
    } else {
      
      BR_PLAYER_VAL_IMPORT_fn(Year = i, Player_data_type = "pitching")
  
    }
}

```

## Clean the BR Player Value Data

Clean the data:

+ names in these tables scraped from `Baseball Reference` are encoded differently from the `CHADWICK DB` and cannot be coerced for joining

+ scraped data in these tables do not contain `Baseball Reference` playerids

  + add playerids from the `CHADWICK DB` in order to scrape individual player pages
    to account for players that changed teams within a given season

```{r Join BBRef data and correct columns, include = T, warning = F, message = F, echo = T}
  ## Combine the each data "type" into one df
Player_Value_Batting_ALL = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Value_batting") == T)]), full_join)

# Player_Value_pitching_2021 = Player_Value_pitching_2021 %>%
#   dplyr::select(-RA9extras)
Player_Value_Pitching_ALL = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Value_pitching") == T)]), full_join)
  ## remove individual (yearly) dfs
rm(list = ls()[which(grepl(ls(), pattern = "batting_2|pitching_2") == T)])

Player_Value_Pitching_ALL = BR_PLAYER_VAL_CLEAN_fn(df = Player_Value_Pitching_ALL, Player_data_type = "pitching")
Player_Value_Batting_ALL = BR_PLAYER_VAL_CLEAN_fn(df = Player_Value_Batting_ALL, Player_data_type = "batting")

pitchernames = Player_Value_Pitching_ALL %>%
  dplyr::select(Name) %>%
  as.vector() %>%
  unlist() %>%
  as.character()
hitternames = Player_Value_Batting_ALL %>%
  dplyr::select(Name) %>%
  as.vector() %>%
  unlist() %>%
  as.character()


## use the Chadwick DB as a cross-ref for playerids
CHAD_LU = baseballr::chadwick_player_lu()

  ## concatenate the separated strings for players with initials as first names;
  ## remove players without bbref ids and remove excess columns
CHAD_LU = CHAD_LU %>%
  dplyr::mutate(name_first = case_when(grepl(name_first, pattern = "[A-Z]\\.") ~
                                         gsub(name_first, pattern = "\\s", replacement = ""),
                                       TRUE ~ name_first)) %>%
  dplyr::filter(key_bbref != "") %>%
  dplyr::mutate(Name = paste(name_first, name_last, sep = " ")) %>%
  dplyr::select(contains("name"),
                contains("Name"),
                key_mlbam,
                key_bbref,
                key_fangraphs,
                key_retro,
                contains("mlb_played"))

## because of encoding discrepancies, will need to loop through and assign bbref ids and last initials for each player in the dataset
  ## function created for this
    ## used to enable scraping individual bbref pages (for when players changed teams in this project)
Player_Value_Batting_ALL = ID_ADD_fn(df = Player_Value_Batting_ALL, player_type = "hitters", site_abbrev = "bbref")

Player_Value_Pitching_ALL = ID_ADD_fn(df = Player_Value_Pitching_ALL, player_type = "pitchers", site_abbrev = "bbref")

```

Correct hitter name spellings and IDs (not shown)

```{r Correct hitter name spellings and ids, eval = T, include = T, warning = F, message = F, echo = F}

## correct names that impacted ids and last name initials
  ## -> all juniors, players with accents, or different first names between CHAD and bbref

Player_Value_Batting_ALL = Player_Value_Batting_ALL %>%
  
  
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Jackie") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jackie Bradley")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Vladimir") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Vladimir Guerrero") &
                                                       grepl(key_bbref, pattern = "2")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Souza") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Souza") &
                                                       grepl(name_first, pattern = "Steven")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Ronald") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ronald") &
                                                       grepl(name_matrilineal, pattern = "Blanco")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Dwight") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Dwight Smith") &
                                                       grepl(name_suffix, pattern = "Jr.")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Lourdes") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Lourdes")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Shed") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Shed")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Tatis") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Fernando Tat")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "LaMonte") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "LaMonte Wade")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jazz") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jazz")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Kazmar") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Kazmar")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Luis") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Luis Robert")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Stokes") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Troy Stokes")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Eric Young") &
                                                       grepl(name_suffix, pattern = "Jr.")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     TRUE ~ bbref_id
                                     ),
                lastinit = str_extract(bbref_id, pattern = "[a-z]{1}"),
                
                
                ## correct additional oddities
                bbref_id = case_when(grepl(Name, pattern = "Alejandro") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "De Aza")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Iv") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Iv") &
                                                       grepl(name_last, pattern = "De Jes")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Wily") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Wily Mo")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Van") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Van") &
                                                       grepl(name_first, pattern = "Scott")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Dekker") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "den Dekker")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Gosselin") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Gosselin")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Murphy") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Murphy") &
                                                       grepl(name_given, pattern = "John Ryan")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Tommy") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Tommy") &
                                                       grepl(name_given, pattern = "Thomas Frank")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Yolmer") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Yolmer")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Michael") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Michael Taylor") &
                                                       grepl(name_given, pattern = "Michael A")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Kang") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Kang")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Choi") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Choi") &
                                                       grepl(name_given, pattern = "Ji Man")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Hyun") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Hyun") &
                                                       grepl(name_first, pattern = "Hyun Soo")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Byung") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Byung Ho")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Reed") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Reed") &
                                                       grepl(name_given, pattern = "Andrew Joseph")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Vogelbach") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Vogelbach")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Nicky") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Delmonico")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Granite") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Granite")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Fernandez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jos") &
                                                       grepl(key_bbref, pattern = "fernajo03")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Alex") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Alex") &
                                                       grepl(name_last, pattern = "De Goti")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Bryan") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Bryan") &
                                                       grepl(name_last, pattern = "De La Cruz")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id
                                     ),
                
                ## and their lastname initial
                lastinit = str_extract(bbref_id, pattern = "[a-z]{1}")
                )

Player_Value_Batting_ALL = Player_Value_Batting_ALL %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Bill") &
                                       grepl(Name, pattern = "Hall") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Hall" &
                                                       name_given == "William") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "John") &
                                       grepl(Name, pattern = "McDonald") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "McDonald" &
                                                       mlb_played_last == 2014) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Chris") &
                                       grepl(Name, pattern = "Young") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Young" &
                                                       name_given == "Christopher Brandon") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Nelson") &
                                       grepl(Name, pattern = "Cruz") ~ CHAD_LU %>%
                                       dplyr::filter(name_given == "Nelson Ramon" &
                                                       name_last == "Cruz") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Ike") &
                                       grepl(Name, pattern = "Davis") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Ike Davis" &
                                                       name_given == "Isaac Benjamin") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Luis") &
                                           grepl(Name, pattern = "Jimenez") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Luis Jimenez" &
                                                       name_given == "Luis Domingo") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Boog") &
                                       grepl(Name, pattern = "Powell") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Boog Powell" &
                                                       name_given == "Herschel Mack") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id))



```

Repeat for pitchers and remove hitters from the data frame (not shown)

```{r Correct pitcher name spellings and ids 2, eval = T, include = T, message = F, warning = F, echo = F}

Player_Value_Pitching_ALL = Player_Value_Pitching_ALL %>%
  
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "III") &
                                       grepl(Name, pattern = "Alvarez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Henderson")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "III") &
                                       grepl(Name, pattern = "Vidal") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "nunovi01") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Fernando") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Fernando") &
                                                       grepl(name_last, pattern = "Rodr")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Carl") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Carl") &
                                                       grepl(name_last, pattern = "Edwards")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Lance") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "McCullers") &
                                                       name_suffix == "Jr.") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Wright") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Mike") &
                                                       grepl(name_last, pattern = "Wright")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Leiter") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Leiter") &
                                                       name_suffix == "Jr.") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Underwood") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "Underwood") &
                                                       grepl(name_given, pattern = "Duane Lee")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Flores") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "Flores") &
                                                       grepl(name_first, pattern = "Bernardo")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jr.") &
                                       grepl(Name, pattern = "Honeywell") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "Honeywell")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     TRUE ~ bbref_id),
                
                ## Des
                bbref_id = case_when(grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Justin") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Justin" &
                                                       grepl(name_last, pattern = "Fratus")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Frankie") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "De") &
                                                       grepl(name_first, pattern = "Frankie")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Dane") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Dane" &
                                                       grepl(name_last, pattern = "Rosa")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Jorge") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Jorge" &
                                                       grepl(name_last, pattern = "De La")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Rubby") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Rubby") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       grepl(Name, pattern = "Eury") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Eury" &
                                                       name_last == "De La Rosa") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Fautino") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Fautino") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Enerio") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Enerio") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Cole") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Cole" &
                                                       name_last == "De Vries") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jose") &
                                       grepl(Name, pattern = "Torre") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Jose" &
                                                       name_last == "De La Torre") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Jorge") &
                                       grepl(Name, pattern = "Leon") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Jorge" &
                                                       name_last == "De Leon") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Abel") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Abel" &
                                                       name_last == "De Los Santos") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Paula") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Jose" &
                                                       name_last == "De Paula") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       grepl(Name, pattern = "Joel") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Joel" &
                                                       name_last == "De La Cruz") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "De") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Jos") &
                                       grepl(Name, pattern = "Le") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jos") &
                                                       grepl(name_given, pattern = "Eugenio")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jong") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Chase" &
                                                       name_last == "De Jong") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Enyel") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Enyel") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Pozo") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Pozo") &
                                                       name_first == "Miguel") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     is.na(bbref_id) &
                                       grepl(Name, pattern = "Hurk") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "van den Hurk")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     is.na(bbref_id) &
                                       grepl(Name, pattern = "Oviedo") ~ CHAD_LU %>%
                                       dplyr::filter(name_given == "Juan Carlos" &
                                                       name_last == "Oviedo") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     is.na(bbref_id) &
                                       grepl(Name, pattern = "Niese") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Niese") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     is.na(bbref_id) &
                                       grepl(Name, pattern = "JC") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "J") &
                                                       grepl(Name, pattern = "C") &
                                                       grepl(Name, pattern = "Ram")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Ryu") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Ryu" &
                                                       name_first == "Hyun Jin") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     TRUE ~ bbref_id),
                
                ## misfits
                bbref_id = case_when(grepl(Name, pattern = "Boyd") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Boyd" &
                                                       grepl(Name, pattern = "Matt")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Chi") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Chi Chi")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Sugar") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Sugar Ray")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Josh") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Josh") &
                                                       name_given == "Joshua Allen") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Felipe") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_last, pattern = "V") &
                                                       name_given == "Felipe Javier") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Bowman") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Bowman" &
                                                       name_first == "Matthew") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Chargois") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Chargois") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Whalen") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Whalen") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Chasen Bradford") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Chase" &
                                                       name_given == "Chasen David") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Infante") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Infante" &
                                                       grepl(name_first, pattern = "Greg")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "King") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "King" &
                                                       grepl(name_first, pattern = "Mi")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Reed") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Reed" &
                                                       name_first == "A.J.") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Lakins") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Travis" &
                                                       name_last == "Lakins") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Ponce") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Daniel" &
                                                       grepl(name_last, pattern = "Ponce")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Josh") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "D.") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Josh") &
                                                       name_given == "Joshua Dwayne") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Lakins") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Travis" &
                                                       name_last == "Lakins") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Locke") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Locke") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Daniel") &
                                       is.na(bbref_id) &
                                       grepl(Name, pattern = "Cam") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(name_first, pattern = "Dan") &
                                                       grepl(name_last, pattern = "Cam")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Vladimir") &
                                       is.na(bbref_id) ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Vladimir" &
                                                       grepl(name_last, pattern = "Guti")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Kwang") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Kim" &
                                                       grepl(name_first, pattern = "Kwang")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Lynch") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Lynch" &
                                                       name_first == "Daniel") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id
                                     ),
                lastinit = str_extract(bbref_id, pattern = "[a-z]{1}")
  ) %>%
  dplyr::filter(!is.na(bbref_id))


Player_Value_Pitching_ALL = Player_Value_Pitching_ALL %>%
  dplyr::filter(bbref_id %notin% Player_Value_Batting_ALL$bbref_id) %>%
  dplyr::filter(bbref_id != "mcdonjo01") %>%
  dplyr::filter(bbref_id != "fieldjo04") %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Mike") &
                                       grepl(Name, pattern = "Adams") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Adams" &
                                                       name_given == "Jon Michael") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Rich") &
                                       grepl(Name, pattern = "Thompson") ~ CHAD_LU %>%
                                       dplyr::filter(name_last == "Thompson" &
                                                       name_given == "Richard Graeme") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Freddy") &
                                       grepl(Name, pattern = "Garcia") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Freddy Garcia" &
                                                       name_given == "Freddy Antonio") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Joe") &
                                       grepl(Name, pattern = "Kelly") ~CHAD_LU %>%
                                       dplyr::filter(name_given == "Joseph William" &
                                                       name_last == "Kelly") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Josh") &
                                       grepl(Name, pattern = "Fields") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Josh Fields" &
                                                       name_given == "Joshua David") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Joe") &
                                       grepl(Name, pattern = "Smith") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Joe Smith" &
                                                       name_given == "Joseph Michael") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Diego") &
                                       grepl(Name, pattern = "Castillo") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Diego Castillo" &
                                                       name_given == "Diego") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Austin") &
                                       grepl(Name, pattern = "Davis") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Austin Davis" &
                                                       name_given == "Austin Richard") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Erik") &
                                       grepl(Name, pattern = "Johnson") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Erik Johnson" &
                                                       name_given == "Erik Craig") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Jeff") &
                                       grepl(Name, pattern = "Gray") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Jeff Gray" &
                                                       name_given == "Jeffrey Michael") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Logan") &
                                       grepl(Name, pattern = "Allen") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Logan Allen" &
                                                       name_given == "Logan Shane") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     grepl(Name, pattern = "Walker") &
                                       grepl(Name, pattern = "Lockett") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Walker Lockett") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id
                                     ),
                
                lastinit = str_extract(bbref_id, pattern = "[a-z]{1}")
  )
```

```{r scratch, eval = F, include = F, message = F, warning = F, echo = F}

str_extract(hitternames[9], pattern = "\\s+.*$") # first name
str_split_1(hitternames[9], pattern = "\\s+") # all names split
str_extract(pitchernames[11], pattern = "\\S+") # first name
str_split_1(pitchernames[11], pattern = "\\s+") # all names split

```

```{r scratch 2, eval = F, include = F, warning = F, echo = F, message = F}

## Create a function to clean the hitter dfs
clean_br_hitter_value_df_fn = function(df){
  ## Remove the "Rk" column
  df = df[ , -1 ]
  ## Remove the handedness coded into the "Name" column; first extract that info into a new column
  df = df %>%
    dplyr::mutate(Bats = case_when(grepl(Name, pattern = "\\*") ~ "L",
                                   grepl(Name, pattern = "\\#") ~ "S",
                                   TRUE ~ "R"), .after = 1) %>%
    dplyr::mutate(Name = gsub(Name, pattern = "\\*|\\#", replacement = ""))
  
  Encoding(df$Name) = "UTF-8"
  df$Name = iconv(df$Name, "UTF-8", "UTF-8", sub = " ")
  colnames(df)[25] = "Pos.Summary"
  ## Remove pitchers from the hitters df
  df = df %>%
    dplyr::mutate(idx = case_when(grepl(Pos.Summary, pattern = "1|\\/1|([0-9]-Jan)") ~ 1,
                                  TRUE ~ 0)
    ) %>%
    dplyr::filter(idx == 0)
  
  df = df %>%
    dplyr::mutate(Name = case_when(grepl(Name, pattern = "<a0>") ~ gsub(Name, pattern = "<a0>", replacement = " "),
                                   grepl(Name, pattern = "<ed>") ~ gsub(Name, pattern = "<ed>", replacement = "i"),
                                   grepl(Name, pattern = "<e1>") ~ gsub(Name, pattern = "<e1>", replacement = "a"),
                                   grepl(Name, pattern = "<fa>") ~ gsub(Name, pattern = "<fa>", replacement = "u"),
                                   grepl(Name, pattern = "<e9>") ~ gsub(Name, pattern = "<e9>", replacement = "e"),
                                   TRUE ~ Name))
  
  
  ## Convert the "salary" column
  df$Salary = as.numeric(gsub(df$Salary, pattern = "\\$|\\,", replacement = ""))/1000000
  rownames(df) = NULL
  return(df)
}

## Create functions to clean the pitcher dfs
clean_br_pitcher_value_df_fn = function(df){
  ## Remove the "Rk" column
  df = df[ , -1 ]
  ## Remove the handedness coded into the "Name" column; first extract that info into a new column
  df = df %>%
    dplyr::mutate(Throws = case_when(grepl(Name, pattern = "\\*") ~ "L",
                                     TRUE ~ "R"),
                  Name = gsub(Name, pattern = "\\*|\\#", replacement = ""))
  ## Convert to UTF-8 and remove special characters
  Encoding(df$Name) = "UTF-8"
  df$Name = iconv(df$Name, "UTF-8", "UTF-8", sub = " ")
  
  df = df %>%
    dplyr::mutate(Throws = case_when(grepl(Name, pattern = "<a0>") ~ "L",
                                     TRUE ~ "R"), .after = 1) %>%
    dplyr::mutate(Name = case_when(grepl(Name, pattern = "<a0>") ~ gsub(Name, pattern = "<a0>", replacement = " "),
                                   grepl(Name, pattern = "<ed>") ~ gsub(Name, pattern = "<ed>", replacement = "i"),
                                   grepl(Name, pattern = "<e1>") ~ gsub(Name, pattern = "<e1>", replacement = "a"),
                                   grepl(Name, pattern = "<fa>") ~ gsub(Name, pattern = "<fa>", replacement = "u"),
                                   grepl(Name, pattern = "<e9>") ~ gsub(Name, pattern = "<e9>", replacement = "e"),
                                   TRUE ~ Name))
  ## Convert the "salary" column
  df$Salary = as.numeric(gsub(df$Salary, pattern = "\\$|\\,", replacement = ""))/1000000
  rownames(df) = NULL
  return(df)
}

Player_Value_Batting_ALL = clean_br_hitter_value_df_fn(df = Player_Value_Batting_ALL)
Player_Value_Pitching_ALL = clean_br_pitcher_value_df_fn(df = Player_Value_Pitching_ALL)

  ## repeat for hitters for anything that was somehow missed
Player_Value_Batting_ALL= Player_Value_Batting_ALL %>%
  dplyr::mutate(Name = case_when(grepl(Name, pattern = "<a0>") ~ gsub(Name, pattern = "<a0>", replacement = " "),
                                 grepl(Name, pattern = "<ed>") ~ gsub(Name, pattern = "<ed>", replacement = "i"),
                                 grepl(Name, pattern = "<e1>") ~ gsub(Name, pattern = "<e1>", replacement = "a"),
                                 grepl(Name, pattern = "<fa>") ~ gsub(Name, pattern = "<fa>", replacement = "u"),
                                 grepl(Name, pattern = "<e9>") ~ gsub(Name, pattern = "<e9>", replacement = "e"),
                                 TRUE ~ Name)) %>%
  dplyr::select(-idx)
```

```{r scratch 3, eval = F, include = F, warning = F, message = F, echo = F, message = F}
pitchers = unique(Player_Value_Pitching_ALL$playerid)
hitters = unique(Player_Value_Batting_ALL$playerid)

pitchers[which(pitchers %in% hitters)]
hitters[which(hitters %in% pitchers)]


## Remove hitters from the pitchers data
Player_Value_Pitching_ALL = Player_Value_Pitching_ALL %>%
  dplyr::mutate(idx = case_when(playerid %in% hitters ~ 0,
                                TRUE ~ 1)) %>%
  dplyr::filter(idx == 1) %>%
  dplyr::mutate(Name = case_when(grepl(Name, pattern = "<a0>") ~ gsub(Name, pattern = "<a0>", replacement = " "),
                                 grepl(Name, pattern = "<ed>") ~ gsub(Name, pattern = "<ed>", replacement = "i"),
                                 grepl(Name, pattern = "<e1>") ~ gsub(Name, pattern = "<e1>", replacement = "a"),
                                 grepl(Name, pattern = "<fa>") ~ gsub(Name, pattern = "<fa>", replacement = "u"),
                                 grepl(Name, pattern = "<e9>") ~ gsub(Name, pattern = "<e9>", replacement = "e"),
                                 TRUE ~ Name)) %>% 
  dplyr::select(-idx)

## find and correct pitchers names with accents
accent_names = Player_Value_Pitching_ALL %>%
  dplyr::mutate(idx = case_when(grepl(Name, pattern = "[A-Z]{1}\\s[a-z]|[a-z]{1}\\s[a-z]|\\s[A-Z]{1}\\s") ~ 0,
                                TRUE ~ 1)) %>%
  dplyr::filter(idx == 0) %>%
  dplyr::select(Name) %>%
  dplyr::distinct() %>%
  as.vector() %>%
  unlist() %>%
  as.character()

Player_Value_Pitching_ALL = Player_Value_Pitching_ALL %>%
  dplyr::mutate(Name = case_when(Name == accent_names[1] ~ "Danys Baez",
                                 Name == accent_names[2] ~ "Livan Hernandez",
                                 Name == accent_names[5] ~ "Miguel Gonzalez",
                                 Name == accent_names[6] ~ "Yoslan Herrera",
                                 Name == accent_names[7] ~ "Yoan Lopez",
                                 Name == accent_names[9] ~ "Michael Baez",
                                 Name == accent_names[10] ~ "Jose Rodriguez",
                                 Name == accent_names[12] ~ "Vladimir Gutierrez",
                                 TRUE ~ Name) )


accent_names = Player_Value_Batting_ALL %>%
  dplyr::mutate(idx = case_when(grepl(Name, pattern = "[A-Z]{1}\\s[a-z]|[a-z]{1}\\s[a-z]|\\s[A-Z]{1}\\s") ~ 0,
                                TRUE ~ 1)) %>%
  dplyr::filter(idx == 0) %>%
  dplyr::select(Name) %>%
  dplyr::distinct() %>%
  as.vector() %>%
  unlist() %>%
  as.character()

Player_Value_Batting_ALL = Player_Value_Batting_ALL %>%
  dplyr::mutate(Name = case_when(Name == accent_names[2] ~ "Alexei Ramirez",
                                 Name == accent_names[3] ~ "Dayan Vicideo",
                                 Name == accent_names[4] ~ "Yoenis Cespedes",
                                 Name == accent_names[7] ~ "Hector Olivera",
                                 Name == accent_names[8] ~ "Yasmany Tomas",
                                 Name == accent_names[9] ~ "Aledmys Diaz",
                                 Name == accent_names[10] ~ "Yandy Diaz",
                                 Name == accent_names[11] ~ "Adolis Garcia",
                                 Name == accent_names[12] ~ "Jorge Ona",
                                 TRUE ~ Name) )

```

## Determine Career-Level bWAR and Value

+ Aggregate the player value data to obtain `Career bWAR`, `Career Salary`, and `Service time`

+ Aggregate the player value data to obtain `Player-Year-level` `bWAR` and `Salaries`

```{r Summarize the data, include = T, warning = F, echo = T, message = F}

CAREER_hitter_WAR_df = Player_Value_Batting_ALL %>%
  dplyr::group_by(Name, bbref_id) %>%
  dplyr::summarize(Career_bWAR = as.numeric(round(sum(as.numeric(WAR), na.rm = T), 1)),
                   Career_Sal = sum(Salary, na.rm = T),
                   Service_time = max(as.numeric(Age)) - min(as.numeric(Age)))

CAREER_pitcher_WAR_df = Player_Value_Pitching_ALL %>%
  dplyr::group_by(Name, bbref_id) %>%
  dplyr::summarize(Career_bWAR = as.numeric(round(sum(as.numeric(WAR), na.rm = T), 1)),
                   Career_Sal = sum(Salary, na.rm = T),
                   Service_time = max(as.numeric(Age)) - min(as.numeric(Age)))

CAREER_WAR_df = CAREER_hitter_WAR_df %>%
  dplyr::full_join(CAREER_pitcher_WAR_df, by = c("Name", "bbref_id", "Career_bWAR", "Career_Sal", "Service_time")) %>%
  dplyr::arrange(desc(Career_bWAR))



Hitter_year_WAR_df = Player_Value_Batting_ALL %>%
  dplyr::group_by(Name, bbref_id, Year) %>%
  dplyr::summarize(WAR = as.numeric(round(sum(as.numeric(WAR), na.rm = T), 1)),
                   Age = as.numeric(round(max(as.numeric(Age), na.rm = T))),
                   Salary = as.numeric(mean(Salary, na.rm = T))) %>%
  dplyr::ungroup() %>%
  dplyr::select(Name, bbref_id, Year, WAR, Salary, Age)

Pitcher_year_WAR_df = Player_Value_Pitching_ALL %>%
  dplyr::group_by(Name, bbref_id, Year) %>%
  dplyr::summarize(WAR = as.numeric(round(sum(as.numeric(WAR), na.rm = T), 1)),
                   Age = as.numeric(round(max(as.numeric(Age), na.rm = T))),
                   Salary = as.numeric(mean(Salary, na.rm = T)),
                   Year = max(Year, na.rm = T)) %>%
  dplyr::ungroup() %>%
  dplyr::select(Name, bbref_id, Year, WAR, Salary, Age)

PLAYER_YEAR_WAR_df = Hitter_year_WAR_df %>%
  dplyr::full_join(Pitcher_year_WAR_df, by = c("Name", "bbref_id", "Year", "WAR", "Salary", "Age")) %>%
  dplyr::arrange(desc(as.numeric(Salary)))

rm(list = ls()[which(grepl(ls(), pattern = "CAREER_hitter|CAREER_pitcher|Hitter_year|Pitcher_year"))])
```

# Baseball Reference Team Salary/Payroll data {.tabset .tabset-pills .tabset-fade}

Acquire team salary data

## Scrape and Clean Team Salary/Payroll data 

```{r Scrape team bWAR and salary/payroll data from Baseball Reference, include = T, warning = F, echo = T, message = F}
  ## Loop through the relevant years and import the tables as dataframes
for ( i in 11:21 ){
  if (i %% 17 == 0 ) {
    
      Sys.sleep(60)
      BR_TEAM_VALUE_IMPORT_fn(Year = i, Player_data_type = "batting")
    
    } else {
      
      BR_TEAM_VALUE_IMPORT_fn(Year = i, Player_data_type = "batting")
    }
}
  ## Repeat the loop for pitching stats
for ( i in 11:21 ){
  if( i %% 17 == 0 ) {
    
    Sys.sleep(60)
    BR_TEAM_VALUE_IMPORT_fn(Year = i, Player_data_type = "pitching")
    
  } else {
    
    BR_TEAM_VALUE_IMPORT_fn(Year = i, Player_data_type = "pitching")
  }
}
  ## Concatenate into a aggregate dataframes by player type
TeamBatALL = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Team_batting") == T)]), full_join)

  ## Remove the Xinn pitching column
Team_pitchingvalue_2021 = Team_pitchingvalue_2021 %>%
  dplyr::select(-RA9extras)

TeamPitALL = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Team_pitching") == T)]), full_join)

TeamPitALL = TeamPitALL %>%
  dplyr::filter(Tm != "0" &
                  Tm != "") %>%
  dplyr::mutate(Tm = case_when(grepl(Tm, pattern = "Angels") ~ "Los Angeles Angels",
                               grepl(Tm, pattern = "Marlins") ~ "Miami Marlins",
                               grepl(Tm, pattern = "Cleveland") ~ "Cleveland Guardians",
                               TRUE ~ Tm))

## Remove league summ rows and correct team names
TeamBatALL = TeamBatALL %>%
  dplyr::filter(Tm != "0" &
                  Tm != "") %>%
  dplyr::mutate(Tm = case_when(grepl(Tm, pattern = "Angels") ~ "Los Angeles Angels",
                               grepl(Tm, pattern = "Marlins") ~ "Miami Marlins",
                               grepl(Tm, pattern = "Cleveland") ~ "Cleveland Guardians",
                               TRUE ~ Tm))
rm(list = ls()[which(grepl(ls(), pattern = "Team_batting|Team_pitching") == T)])
```

## Clean Individual Player Salary/Payroll Data

Add player acquisition data to the cleaned `Baseball Reference` player value data

+ first, identify players who changed teams

```{r Correct hitter positions, eval = F, include = T, message = F, warning = F, echo = F}
  ## Loop through and tab each team's number of acqusitions for the main acq. types in each year;
    ## Put them in their own dfs
      ## For hitters
Player_Value_Batting_ALL = Player_Value_Batting_ALL %>%
  dplyr::mutate(Positions = gsub(Pos.Summary, pattern = "\\*|\\/|D|H", replacement = "")) %>%
  dplyr::mutate(Positions = case_when(grepl(Positions, pattern = "\\-Mar") ~ gsub(Positions, pattern = "\\-Mar", replacement = "03"),
                                      grepl(Positions, pattern = "\\-Apr") ~ gsub(Positions, pattern = "\\-Apr", replacement = "04"),
                                      grepl(Positions, pattern = "\\-May") ~ gsub(Positions, pattern = "\\-May", replacement = "05"),
                                      grepl(Positions, pattern = "\\-Jun") ~ gsub(Positions, pattern = "\\-Jun", replacement = "06"),
                                      grepl(Positions, pattern = "\\-Jul") ~ gsub(Positions, pattern = "\\-Jul", replacement = "07"),
                                      grepl(Positions, pattern = "\\-Aug") ~ gsub(Positions, pattern = "\\-Aug", replacement = "08"),
                                      grepl(Positions, pattern = "\\-Sep") ~ gsub(Positions, pattern = "\\-Sep", replacement = "09"),
                                      Positions == "" ~ "0",
                                      TRUE ~ Positions))

batPositions = Player_Value_Batting_ALL %>%
  dplyr::select(Positions) %>%
  as.vector() %>%
  unlist() %>%
  as.character()

listy = vector()

for (i in 1:length(batPositions)) {
  listy[i] = str_extract_all(strsplit(batPositions[i], split = "\\D"), pattern = "[:digit:]")
  
  for (j in 1:length(listy[[i]])) {
    
    if (listy[[i]][j] == 0){
      listy[[i]][j] = "DH"
  }
    if (listy[[i]][j] == 2){
      listy[[i]][j] = "C"
  }
    if (listy[[i]][j] == 3){
      listy[[i]][j] = "1B"
  }
    if (listy[[i]][j] == 4){
      listy[[i]][j] = "2B"
  }
    if (listy[[i]][j] == 5){
      listy[[i]][j] = "3B"
  }
    if (listy[[i]][j] == 6){
      listy[[i]][j] = "SS"
  }
    if (listy[[i]][j] == 7){
      listy[[i]][j] = "LF"
  }
    if (listy[[i]][j] == 8){
      listy[[i]][j] = "CF"
  }
    if (listy[[i]][j] == 9){
      listy[[i]][j] = "RF"
    }
    }
  batPositions[i] = paste(unlist(listy[[i]]), collapse = " ")
}


Player_Value_Batting_ALL = Player_Value_Batting_ALL %>%
  dplyr::mutate(Positions = batPositions)
```

```{r Identify players who changed teams, include = T, warning = F, echo = T, message = F}

Team_Changers_hitters = Player_Value_Batting_ALL %>%
  dplyr::filter(grepl(Tm, pattern = "TM")) %>%
  dplyr::mutate(Tms = Tm) %>%
  dplyr::select(Name, lastinit, bbref_id, Year, Tms, Salary, Acquired) %>%
  dplyr::distinct()


Team_Changers_pitchers = Player_Value_Pitching_ALL %>%
  dplyr::filter(grepl(Tm, pattern = "TM")) %>%
  dplyr::mutate(Tms = Tm) %>%
  dplyr::select(Name, lastinit, bbref_id, Year, Tms, Salary, Acquired) %>%
  dplyr::distinct()
```

+ next, scrape the player's `Baseball Reference` player page to identify which teams for whom these players played

  + for hitters first
  
  + aggregate the data

```{r Scrape Individual hitters pages, include = T, message = F, warning = F, echo = T}

for (i in 1:nrow(Team_Changers_hitters)){
  if (i %% 17 == 0) {
    
    Sys.sleep(60)
    
    BR_PLAYER_CHANGER_IMPORT_fn(year = Team_Changers_hitters$Year[i],
                                lastinitial = Team_Changers_hitters$lastinit[i],
                                bbref_id = Team_Changers_hitters$bbref_id[i],
                                Player_data_type = "batting")
    
  } else {
    
    BR_PLAYER_CHANGER_IMPORT_fn(year = Team_Changers_hitters$Year[i],
                                lastinitial = Team_Changers_hitters$lastinit[i],
                                bbref_id = Team_Changers_hitters$bbref_id[i],
                                Player_data_type = "batting")
    
  }
}


Changing_hitters = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Changer_") == T)]), full_join)
rm(list = ls()[which(grepl(ls(), pattern = "Changer_") == T)])

Team_Changers_hitters = Team_Changers_hitters %>%
  dplyr::ungroup() %>%
  left_join(Changing_hitters, by = c("lastinit", "bbref_id", "Year")) %>%
  # dplyr::mutate(Tm = case_when(is.na(Tm.x) ~ Tm.y,
  #                              TRUE ~ Tm.x)) %>%
  # dplyr::select(-Tm.x, -Tm.y) %>%
  dplyr::mutate(From = case_when(bbref_id == lead(bbref_id) ~ Tm,
                                 TRUE ~ ""),
                From = case_when(From == ""  ~ lag(From),
                                 TRUE ~ From),
                To = case_when(bbref_id == lag(bbref_id) ~ Tm,
                               TRUE ~ ""),
                To = case_when(To == "" ~ lead(To),
                               TRUE ~ To)) %>%
  dplyr::distinct() %>%
  # dplyr::group_by(bbref_id, Year, Tm) %>%
  dplyr::mutate(Salary = case_when(!is.na(Salary) &
                                     Salary > 0 &
                                     grepl(Acquired, pattern = "Traded|Waivers|Amateur Draft|Free|Conditional") &
                                     Tm == From ~ -Salary,
                                   TRUE ~ Salary)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(bbref_id, Year, Tm) %>%
  dplyr::select(-From, -To) %>%
  dplyr::distinct()


```

  + repeat for pitchers
  
```{r Scrape Individual pitchers pages, include = T, message = F, warning = F, echo = T}

for (i in 1:nrow(Team_Changers_pitchers)){
  if (i %% 17 == 0) {
    
    Sys.sleep(60)
    
    BR_PLAYER_CHANGER_IMPORT_fn(year = Team_Changers_pitchers$Year[i],
                                lastinitial = Team_Changers_pitchers$lastinit[i],
                                bbref_id = Team_Changers_pitchers$bbref_id[i],
                                Player_data_type = "pitching")
    
  } else {
    
    BR_PLAYER_CHANGER_IMPORT_fn(year = Team_Changers_pitchers$Year[i],
                                lastinitial = Team_Changers_pitchers$lastinit[i],
                                bbref_id = Team_Changers_pitchers$bbref_id[i],
                                Player_data_type = "pitching")
    
  }
}

  ## join all the individual dfs
Changing_pitchers = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Changer_") == T)]), full_join)
  ## remove all the individual dfs
rm(list = ls()[which(grepl(ls(), pattern = "Changer_"))])

  ## aggregate by player-team-year to account for the salaries to team payrolls from mid-season
    ## player acquisitions
Team_Changers_pitchers = Team_Changers_pitchers %>%
  left_join(Changing_pitchers, by = c("lastinit", "bbref_id", "Year")) %>%
  dplyr::mutate(From = case_when(bbref_id == lead(bbref_id) ~ Tm,
                                 TRUE ~ ""),
                From = case_when(From == ""  ~ lag(From),
                                 TRUE ~ From),
                To = case_when(bbref_id == lag(bbref_id) ~ Tm,
                               TRUE ~ ""),
                To = case_when(To == "" ~ lead(To),
                               TRUE ~ To)) %>%
  dplyr::select(-Tms, Tm) %>%
  dplyr::distinct() %>%
  dplyr::group_by(bbref_id, Year, Tm) %>%
  dplyr::mutate(Salary = case_when(!is.na(Salary) &
                                     grepl(Acquired, pattern = "Traded|Waivers|Amateur Draft|Free Agency|Conditional") &
                                     Tm == From ~ -Salary,
                                   TRUE ~ Salary)) %>%
  dplyr::ungroup() %>%
  dplyr::group_by(bbref_id, Year, Tm) %>%
  dplyr::select(-From, -To) %>%
  dplyr::distinct()

```

+ aggregate all the changers' data into a `Team_Transactions` df

+ a **negative salary change = to dumping payroll**

+ **positive salary change = adding payroll**

```{r Combine the changers data, include = T, message = F, warning = F, echo = T}
  ## join all hitters and pitchers who changed teams
Team_Transactions_ALL = Team_Changers_hitters %>%
  full_join(Team_Changers_pitchers)

# Team_Changers_ALL %>% # check to see all players are accounted for
#   dplyr::filter(is.na(Tm))

    ## adjust each team's payroll for the players they acquired or traded away
      ## - Salary adjustment = gaining space (salary dumping)
Team_Transactions_Sum = Team_Transactions_ALL %>%
  dplyr::mutate(Tm = case_when(Tm == "WAS" ~ "WSN",
                               Tm == "FLA" ~ "MIA",
                               TRUE ~ Tm)) %>%
  dplyr::group_by(Tm, Year) %>%
  dplyr::summarize(Sum_Num_Trades = sum(case_when(Acquired == "Traded" ~ 1,
                                                  Acquired == "Amateur Draft" ~ 1,
                                                  Acquired == "Conditional Deal" ~ 1,
                                                  TRUE ~ 0), na.rm = T),
                   Sum_Num_FAs = sum(case_when(Acquired == "Free Agency" ~ 1,
                                               Acquired == "Amateur Free Agent" ~ 1,
                                               TRUE ~ 0), na.rm = T),
                   Sum_Num_Claims = sum(case_when(Acquired == "Waivers" ~ 1,
                                                  TRUE ~ 0), na.rm = T),
                   Sum_Acqs = sum(Sum_Num_Claims, Sum_Num_FAs, Sum_Num_Trades),
                   Sum_Sal_Change = sum(Salary, na.rm = T)
                   
                   ) %>%
  dplyr::arrange(Sum_Sal_Change)

Team_Transactions_Sum %>%
  dplyr::filter(Year != "2020")
```

+ Join the `Team_Transactions_Sum` df to the `TeamBatALL`, `TeamPitALL` dfs and summarize

```{r Add Team Abbrevs, include = T, message = F, warning = F, echo = F}

## add a column to the TeamBat and TeamPIT dfs for joining by name
TeamBatALL = TeamBatALL %>%
  dplyr::mutate(Team = Tm, .before = 1) %>%
  dplyr::mutate(Type = "Pit") %>%
  dplyr::mutate(Tm = case_when(grepl(Team, pattern = "Ariz") ~ "ARI",
                               grepl(Team, pattern = "Atl") ~ "ATL",
                               grepl(Team, pattern = "Balt") ~ "BAL",
                               grepl(Team, pattern = "Bos") ~ "BOS",
                               grepl(Team, pattern = "Cubs") ~ "CHC",
                               grepl(Team, pattern = "White") ~ "CHW",
                               grepl(Team, pattern = "Reds") ~ "CIN",
                               grepl(Team, pattern = "Cleve") ~ "CLE",
                               grepl(Team, pattern = "Rock") ~ "COL",
                               grepl(Team, pattern = "Tig") ~ "DET",
                               grepl(Team, pattern = "Marlins") ~ "MIA",
                               grepl(Team, pattern = "Hous") ~ "HOU",
                               grepl(Team, pattern = "Kans") ~ "KCR",
                               grepl(Team, pattern = "Angels") ~ "LAA",
                               grepl(Team, pattern = "Dodg") ~ "LAD",
                               grepl(Team, pattern = "Milw") ~ "MIL",
                               grepl(Team, pattern = "Minn") ~ "MIN",
                               grepl(Team, pattern = "Mets") ~ "NYM",
                               grepl(Team, pattern = "Yank") ~ "NYY",
                               grepl(Team, pattern = "Oak") ~ "OAK",
                               grepl(Team, pattern = "Phil") ~ "PHI",
                               grepl(Team, pattern = "Pitt") ~ "PIT",
                               grepl(Team, pattern = "Diego") ~ "SDP",
                               grepl(Team, pattern = "Seatt") ~ "SEA",
                               grepl(Team, pattern = "Gian") ~ "SFG",
                               grepl(Team, pattern = "Cardi") ~ "STL",
                               grepl(Team, pattern = "Rays") ~ "TBR",
                               grepl(Team, pattern = "Ranger") ~ "TEX",
                               grepl(Team, pattern = "Toro") ~ "TOR",
                               grepl(Team, pattern = "Wash") ~ "WSN")) %>%
  dplyr::select(-G)
```

```{r Add Team Abbrevs, include = T, message = F, warning = F, echo = F}
TeamPitALL = TeamPitALL %>%
  dplyr::mutate(Team = Tm, .before = 1) %>%
  dplyr::mutate(Type = "Pit") %>%
  dplyr::mutate(Tm = case_when(grepl(Team, pattern = "Ariz") ~ "ARI",
                               grepl(Team, pattern = "Atl") ~ "ATL",
                               grepl(Team, pattern = "Balt") ~ "BAL",
                               grepl(Team, pattern = "Bos") ~ "BOS",
                               grepl(Team, pattern = "Cubs") ~ "CHC",
                               grepl(Team, pattern = "White") ~ "CHW",
                               grepl(Team, pattern = "Reds") ~ "CIN",
                               grepl(Team, pattern = "Cleve") ~ "CLE",
                               grepl(Team, pattern = "Rock") ~ "COL",
                               grepl(Team, pattern = "Tig") ~ "DET",
                               grepl(Team, pattern = "Marlins") ~ "MIA",
                               grepl(Team, pattern = "Hous") ~ "HOU",
                               grepl(Team, pattern = "Kans") ~ "KCR",
                               grepl(Team, pattern = "Angels") ~ "LAA",
                               grepl(Team, pattern = "Dodg") ~ "LAD",
                               grepl(Team, pattern = "Milw") ~ "MIL",
                               grepl(Team, pattern = "Minn") ~ "MIN",
                               grepl(Team, pattern = "Mets") ~ "NYM",
                               grepl(Team, pattern = "Yank") ~ "NYY",
                               grepl(Team, pattern = "Oak") ~ "OAK",
                               grepl(Team, pattern = "Phil") ~ "PHI",
                               grepl(Team, pattern = "Pitt") ~ "PIT",
                               grepl(Team, pattern = "Diego") ~ "SDP",
                               grepl(Team, pattern = "Seatt") ~ "SEA",
                               grepl(Team, pattern = "Gian") ~ "SFG",
                               grepl(Team, pattern = "Cardi") ~ "STL",
                               grepl(Team, pattern = "Rays") ~ "TBR",
                               grepl(Team, pattern = "Ranger") ~ "TEX",
                               grepl(Team, pattern = "Toro") ~ "TOR",
                               grepl(Team, pattern = "Wash") ~ "WSN"))
```

```{r Join Team Transaction Data to Team Value Data, include = T, message = F, warning = F, echo = T}
  ## Join with Team Value data and remove extra data
TeamBatALL = TeamBatALL %>%
  left_join(Team_Transactions_Sum) %>%
  dplyr::filter(Year != 2020) %>%
  dplyr::select(Team, Tm, Type, Year, WAR, Salary, Sum_Sal_Change, Sum_Num_Trades, Sum_Num_FAs, Sum_Num_Claims, Sum_Acqs) %>%
  dplyr::arrange(Sum_Sal_Change)
TeamPitALL = TeamPitALL %>%
  left_join(Team_Transactions_Sum) %>%
  dplyr::filter(Year != 2020) %>%
  dplyr::select(Team, Tm, Type, Year, WAR, Salary, Sum_Sal_Change, Sum_Num_Trades, Sum_Num_FAs, Sum_Num_Claims, Sum_Acqs) %>%
  dplyr::arrange(Sum_Sal_Change)

TeamValALL = TeamBatALL %>%
  full_join(TeamPitALL) %>%
  dplyr::mutate(WAR = as.double(WAR)) %>%
  dplyr::group_by(Team, Tm, Year) %>%
  dplyr::summarize(WAR = sum(WAR),
                   Salary = sum(Salary),
                   Sum_Sal_Change = mean(Sum_Sal_Change),
                   Sum_Num_Trades = mean(Sum_Num_Trades),
                   Sum_Num_FAs = mean(Sum_Num_FAs),
                   Sum_Num_Claims = mean(Sum_Num_Claims),
                   Sum_Acqs = mean(Sum_Acqs)) %>%
  dplyr::mutate(Net_Salary = Salary + Sum_Sal_Change) %>%
  dplyr::select(Team, Tm, Year, WAR, Net_Salary, Salary, Sum_Sal_Change, Sum_Num_Trades, Sum_Num_FAs, Sum_Num_Claims, Sum_Acqs)
```

+ Join the `TeamValALL` df to the `StandALL` df

```{r Join Team Val Data to Standings Data, include = T, message = F, warning = F, echo = T}
TeamValALL = StandALL %>%
  dplyr::mutate(Team = Tm, .before = 1) %>%
  dplyr::select(-Tm) %>%
  inner_join(TeamValALL) %>%
  dplyr::arrange(`W-L%`)
```

# Scrape MLB Free-Agent Data {.tabset .tabset-pills .tabset-fade}

## MLers from ESPN

```{r Scrape and clean Free-Agent data from ESPN, include = TRUE, warning = FALSE, echo = TRUE, message = FALSE}
  ## Create a variable for a selector
ESPN_selector = "#my-players-table"
  ## Loop through and import the data for the relevant time-frame
for ( i in 11:21 ) {
  ESPN_FA_import_fn(Year = i, selector = ESPN_selector)
}
  ## Combine the dfs into one df
ESPN = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "ESPN_FA_2") == TRUE)]), full_join)

  ## Remove FA deals to Japanese baseball league and "undisclosed" deals
ESPN = ESPN %>%
  dplyr::filter(Team != "Japan") %>%
  dplyr::filter(Type != "Undisclosed")

rm(list = ls()[which(grepl(ls(), pattern = "ESPN_FA_2") == T)])
```

## Scrape and Clean International Signing Data from Spotrac

```{r Scrape and clean Intl Signing Data from Spotrac, include = TRUE, warning = FALSE, echo = TRUE, message = FALSE}
  ## Loop through the scraping function by the relevant years
for ( i in 11:21 ) {
  Spotrac_Intl_import_fn(Year = i, spotrac_selector = spotrac_Intl_selector)
}
  ## Put all the dfs into one df and remove the separate dfs
IntlALL = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "Intl_Signings_2") == T)]), full_join)

rm(list = ls()[which(grepl(ls(), pattern = "Intl_Signings_2") == T)])
```

## Save Data

```{r Save data, include = T, message = F, warning = F, echo = T}
rm(
  list = ls()[
    which(grepl(ls(), pattern = "listy|Changing|Team_Changers") == T) ]
    )
save.image("~/GitHub/Baseball/Tanking/WranglingEnvironment.RData")
```

# Amateur Draft Data {.tabset .tabset-pills .tabset-fade}

## Scrape and Clean Amateur Draft Data

Scrape amateur draft data from `Baseball Almanac`

Data is rife with errors, so clean it up

```{r Scrape and Clean Amateur draft data, include = T, message = F, warning = F, echo = T}
  ## set the selector
almanac_selector = "#wrapper > div.container > div.ba-table > table"
  ## Loop through and scrape the data starting from Epstein and Luhnow hires with Cubs/Astros (2011) to present
for ( i in 11:21 ){
  BBA_IMPORT_fn(Year = i, selector = almanac_selector)
}
  ## Merge the dataframes together
BBA_DRAFT_ALL = purrr::reduce(mget(ls()[which(grepl(ls(), pattern = "BBA20") == TRUE)]), full_join)
rm(list = ls()[which(grepl(ls(), pattern = "BBA([0-9])") == T)])

Encoding(BBA_DRAFT_ALL$`Player Name`) = "UTF-8"
BBA_DRAFT_ALL$`Player Name` = iconv(BBA_DRAFT_ALL$`Player Name`, "UTF-8", "UTF-8", sub = " ")


  ## Fix team name mistakes
    ## Change " `Drafted By` " to "Tm", and " `Player Name` " to "Name"
BBA_DRAFT_ALL = BBA_DRAFT_ALL %>%
  dplyr::mutate(`Drafted By` = case_when(`Drafted By` == "Chicago" ~ "Chicago Cubs",
                                         `Drafted By` == "Florida Marlins" ~ "Miami Marlins",
                                         grepl(`Drafted By`, pattern = "Miami") ~ "Miami Marlins",
                                         grepl(`Drafted By`, pattern = "Phillies") ~ "Philadelphia Phillies",
                                         grepl(`Drafted By`, pattern = "Pittsburg") ~ "Pittsburgh Pirates",
                                         grepl(`Drafted By`, pattern = "Baltimore") ~ "Baltimore Orioles",
                                         grepl(`Drafted By`, pattern = "Athletics") ~ "Oakland Athletics",
                                         grepl(`Drafted By`, pattern = "Anaheim") ~ "Los Angeles Angels",
                                         grepl(`Drafted By`, pattern = "Senators") ~ "Oakland Athletics",
                                         TRUE ~ `Drafted By`),
                Tm = `Drafted By`,
                Name = `Player Name`) %>%
  dplyr::select(-`Drafted By`, -`Player Name`)

  ## Remove "Carlos Pena" from Chicago Cubs draft records
    ## Remove duplicates
      ## Correct Lance McCullers' name
BBA_DRAFT_ALL = BBA_DRAFT_ALL %>%
  dplyr::filter(Name != "Carlos Pena") %>%
  dplyr::distinct_all() %>%
  dplyr::mutate(Name = case_when(grepl(Name, pattern = "McCullers") ~ "Lance McCullers Jr.",
                                 TRUE ~ Name))

  ## Subset relevant draft data
ASTROS_CUBS_DRAFT_SUB = BBA_DRAFT_ALL %>%
  dplyr::filter(grepl(Tm, pattern = "Houston Astros|Chicago Cubs"))

LEAGUE_DRAFT_SUB = BBA_DRAFT_ALL %>%
  dplyr::filter(!grepl(Tm, pattern = "Houston Astros|Chicago Cubs"))
```

## Add playerids to Draft Data

Add `Baseball Reference` `playerid`s to the data so it can be joined to player career WAR data

+ same process as with the `Baseball Reference` player value data and the `CHADWICK DB` above

```{r Add bbrefids to Draft data, include = T, message = F, warning = F, echo = F}
ASTROS_CUBS_DRAFT_SUB = ASTROS_CUBS_DRAFT_SUB %>%
  left_join(CHAD_LU)

missing_astros_cubs_identifiers = ASTROS_CUBS_DRAFT_SUB %>%
  dplyr::filter(is.na(name_last)) %>%
  dplyr::select(Name) %>%
  unlist() %>%
  as.vector()
ASTROS_CUBS_DRAFT_SUB = ASTROS_CUBS_DRAFT_SUB %>%
  dplyr::filter(!grepl(Name, pattern = "Kevin Brown")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "jonesal03")) %>%
  dplyr::filter(!grepl(Name, pattern = "Carlos Diaz")) %>%
  dplyr::mutate(bbref_id = key_bbref, .before = 9) %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Javier") &
                                       grepl(Name, pattern = "Baez") ~ CHAD_LU %>%
                                        dplyr::filter(grepl(Name, pattern = "Javier B")) %>%
                                        dplyr::select(key_bbref) %>%
                                        as.character(),
                                     
                                      grepl(Name, pattern = "Daniel") &
                                       grepl(Name, pattern = "Vogelb") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Dan Vogelbach") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "McCullers") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "McCullers") &
                                                       name_suffix == "Jr.") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Underwood") &
                                       grepl(Name, pattern = "Duane") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Duane Underwood")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ramon") &
                                       grepl(Name, pattern = "Laureano") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Laureano")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Ralph") &
                                       grepl(Name, pattern = "Garza") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Ralph Garza")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Nelson") &
                                       grepl(Name, pattern = "Velaz") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Nelson Vel")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jeremy") &
                                       grepl(Name, pattern = "Pena") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jeremy Pe")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     TRUE ~ bbref_id )
                
  )


LEAGUE_DRAFT_SUB = LEAGUE_DRAFT_SUB %>%
  left_join(CHAD_LU)
  
LEAGUE_DRAFT_SUB = LEAGUE_DRAFT_SUB %>%
  dplyr::filter(!grepl(key_bbref, pattern = "youngma01")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithjo11") & grepl(Tm, pattern = "Brewers"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithjo07") & grepl(Tm, pattern = "Brewers"))) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "perezju01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "milleju01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "davisau02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "smithja07")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "smithja01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "johnsbr01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "reynoma02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "murphto02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "hudsojo02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "adamsau01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "gonzaal01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "ortij101")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "duffyma02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "poweb101")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "anderdr01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "brownan01")) %>%
  dplyr::filter(!grepl(Phase, pattern = "Phase")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithjo11") & grepl(Tm, pattern = "Pirates"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithjo07") & grepl(Tm, pattern = "Pirates"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "davisau0") & grepl(Tm, pattern = "Boston"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "murphjo01") & grepl(Tm, pattern = "Yankees"))) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "harribr01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "farrejo02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "davisjo07")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "youngma01") & grepl(Tm, pattern = "Miami"))) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "milleja01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "duncafr01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "duncafr02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "ortizlu01")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "ortizlu03") & grepl(Tm, pattern = "Rangers"))) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "anderbr02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "anderbr03")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "huntebr02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "kellypa02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "kellypa03")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "davisau02") & grepl(Tm, pattern = "Phillies"))) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "fitzgmi03")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithch12") & grepl(Tm, pattern = "Rangers"))) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "mccarjo99")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "mccarjo02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "taylobe01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "taylobe99")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "taylobe02")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "allenlo01") & grepl(Tm, pattern = "Boston"))) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "youngda01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "brownke01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "brownke03")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "willsmith04") & grepl(Tm, pattern = "Dodgers"))) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "millj001")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "brownan01") & grepl(Tm, pattern = "Phillies"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "wilsojo01") & grepl(Tm, pattern = "Reds"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithjo0") & grepl(Tm, pattern = "Tigers"))) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "allenni01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "russejo01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "gonzaju02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "campbpa01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "smithda01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "smithda02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "sullibi01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "smithja02")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "smithja04")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "andrecl01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "gonzaed01")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "gonzalu01") & grepl(Tm, pattern = "Brewers"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "bellge02") & grepl(Tm, pattern = "Giants"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithja01") & grepl(Tm, pattern = "Phillies"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithja07") & grepl(Tm, pattern = "Phillies"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithjo08") & grepl(Tm, pattern = "Rangers"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithjo07") & grepl(Tm, pattern = "Rangers"))) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "lopezlu01")) %>%
  dplyr::filter(!grepl(key_bbref, pattern = "lopezlu02")) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithjo08") & grepl(Tm, pattern = "Yankees"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithjo07") & grepl(Tm, pattern = "Yankees"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "allenlo02") & grepl(Tm, pattern = "Rays"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "allenlo01") & grepl(Tm, pattern = "Cleveland"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithja07") & grepl(Tm, pattern = "Angels"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "smithja01") & grepl(Tm, pattern = "Angels"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "harribe03") & grepl(Tm, pattern = "Dodgers"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "rayjo02") & grepl(Tm, pattern = "White Sox"))) %>%
  dplyr::filter(!(grepl(key_bbref, pattern = "milleja01") & grepl(Tm, pattern = "Cleveland"))) %>%
  dplyr::mutate(bbref_id = key_bbref, .before = 9)

LEAGUE_DRAFT_SUB = LEAGUE_DRAFT_SUB %>%
  dplyr::mutate(bbref_id = case_when(grepl(Name, pattern = "Michael") &
                                       grepl(Name, pattern = "Clevinger") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Mike Clevinger")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Noe") &
                                       grepl(Name, pattern = "Ramirez") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "ramirno01") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Nicky") &
                                       grepl(Name, pattern = "Delmonico") ~ CHAD_LU %>%
                                       dplyr::filter(Name == "Nick Delmonico") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Dereck") &
                                       grepl(Name, pattern = "Rodriguez") ~ CHAD_LU %>%
                                       dplyr::filter(name_first == "Dereck") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Faria") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Faria")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Carlos") &
                                       grepl(Name, pattern = "Rodon") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Carlos Rod") &
                                                       name_given == "Carlos Antonio") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Juan") &
                                       grepl(Name, pattern = "Perez") ~ NA,
                                     
                                     grepl(Name, pattern = "Joseph") &
                                       grepl(Name, pattern = "Biagini") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Biagini")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Chasen") &
                                       grepl(Name, pattern = "Bradford") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Chase Bradford")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Austin") &
                                       grepl(Name, pattern = "Davis") ~ NA,
                                     
                                     grepl(Name, pattern = "Tomas") &
                                       grepl(Name, pattern = "Nido") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Tom") &
                                                       grepl(Name, pattern = "Nido")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Mantiply") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Mantiply")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Minter") &
                                       grepl(Name, pattern = "Alex") ~ CHAD_LU %>%
                                       dplyr::filter(name_given == "Alex Jordan") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Chi") &
                                       grepl(Name, pattern = "Gonzalez") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Chi Gon")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Jacoby") &
                                       grepl(Name, pattern = "Jones") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Jacoby Jones")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Kiner") &
                                       grepl(Name, pattern = "Falefa") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Kiner-Falefa")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Murphy") &
                                       grepl(Name, pattern = "John") &
                                       grepl(Tm, pattern = "Yankees") ~ NA,
                                     
                                     grepl(Name, pattern = "Emilio Pagan") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Emilio Pag")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Sherfy") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Sherfy")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Shed Long") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Shed Long")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Riddle") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "JT Riddle")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Locastro") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Locastro")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Granite") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Granite")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Edwin Diaz") &
                                       grepl(Tm, pattern = "Oak") ~ NA,
                                     
                                     grepl(Name, pattern = "Greg Harris") ~ NA,
                                     
                                     grepl(Name, pattern = "John Farrell") ~ NA,
                                     
                                     grepl(Name, pattern = "Mark Leiter") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Mark Leiter")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Mauricio Dubon") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Mauricio Dub")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Matt Young") &
                                       grepl(Tm, pattern = "Miami") ~ NA,
                                     
                                     grepl(Name, pattern = "Jake Miller") &
                                       grepl(Tm, pattern = "Arizona") ~ NA,
                                     
                                     grepl(Name, pattern = "Torii Hunter") ~ NA,
                                     
                                     grepl(Name, pattern = "Frank Duncan") ~ NA,
                                     
                                     grepl(Name, pattern = "Brent Honeywell") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Honeywell")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Troy Stokes") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Troy Stokes")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Brian Hunter") ~ NA,
                                     
                                     grepl(key_bbref, pattern = "kellypa01") ~ NA,
                                     
                                     grepl(Name, pattern = "Mike Fitzgerald") ~ NA,
                                     
                                     grepl(Name, pattern = "Mariano Rivera") ~ NA,
                                     
                                     grepl(Name, pattern = "Benito Santiago") ~ NA,
                                     
                                     grepl(Name, pattern = "Soroka") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Soroka")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Chad Smith") &
                                       grepl(Tm, pattern = "Rangers") ~ NA,
                                     
                                     grepl(Name, pattern = "Pete Fairbanks") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Pete Fairbanks")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(key_bbref, pattern = "brownke04") &
                                       grepl(Tm, pattern = "Dodgers") &
                                       Year == 2015 ~ NA,
                                     
                                     grepl(Name, pattern = "Jeremey Pena") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "penaje02") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Michael King") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "kingmi01") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Andrew Brown") &
                                       grepl(Tm, pattern = "Phillies") ~ NA,
                                     
                                     grepl(Name, pattern = "Nate Lowe") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "lowena01") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Blake Smith") ~ NA,
                                     
                                     grepl(bbref_id, pattern = "wilsojo02") ~ NA,
                                     
                                     grepl(Name, pattern = "Josh Smith") &
                                       grepl(Tm, pattern = "Tigers") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "smithjo11") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Bleday") &
                                       name_last == "Bleday" ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Bleday")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "John Russell") ~ NA,
                                     
                                     grepl(Name, pattern = "Logan Allen") &
                                       Year == 2017 ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "allenlo02") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Julio Gonzalez") ~ NA,
                                     
                                     grepl(Name, pattern = "Andrew Miller") ~ NA,
                                     
                                     grepl(Name, pattern = "Dave Smith") ~ NA,
                                     
                                     grepl(Name, pattern = "Bill Sullivan") ~ NA,
                                     
                                     grepl(Name, pattern = "Eduoard Julien") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Edouard Julien")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(key_bbref, pattern = "smithja03") ~ NA,
                                     
                                     grepl(key_bbref, pattern = "gonzaed02") ~ NA,
                                     
                                     grepl(Name, pattern = "Luis Gonzalez") &
                                       grepl(Tm, pattern = "Brewers") ~ NA,
                                     
                                     grepl(Name, pattern = "George Bell") ~ NA,
                                     
                                     grepl(Name, pattern = "Jake Smith") &
                                       Year == 2018 ~ NA,
                                     
                                     grepl(Name, pattern = "Josh Smith") &
                                       grepl(Tm, pattern = "Texas Rangers") &
                                       Year == 2018 ~ NA,
                                     
                                     grepl(Name, pattern = "Luis Lopez") ~ NA,
                                     
                                     grepl(Name, pattern = "Benito Santiago") &
                                       Year == 2018 ~ NA,
                                     
                                     grepl(Name, pattern = "Andrew Miller") &
                                       Year == 2018 ~ NA,
                                     
                                     grepl(Name, pattern = "Bobby Witt") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Bobby Witt") &
                                                       name_suffix == "Jr.") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "C.J. Abrams") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "CJ Abrams")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Josh Smith") &
                                       grepl(Tm, pattern = "Yankees") ~ NA,
                                     
                                     grepl(Name, pattern = "Logan Allen") &
                                       grepl(Tm, pattern = "Rays") ~ NA,
                                     
                                     grepl(Name, pattern = "Edouard Julien") &
                                       grepl(Tm, pattern = "Twins") ~ CHAD_LU %>%
                                       dplyr::filter(grepl(Name, pattern = "Eduoard Julien")) %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Logan Allen") &
                                       grepl(Tm, pattern = "Cleveland") ~ CHAD_LU %>%
                                       dplyr::filter(key_bbref == "allenlo02") %>%
                                       dplyr::select(key_bbref) %>%
                                       as.character(),
                                     
                                     grepl(Name, pattern = "Max Muncy") &
                                       Year == 2021 ~ NA,
                                     
                                     grepl(Name, pattern = "Jake Smith") &
                                       grepl(Tm, pattern = "Angels") ~ NA,
                                     
                                     grepl(Name, pattern = "Ben Harris") &
                                       grepl(Tm, pattern = "Dodgers") ~ NA,
                                     
                                     grepl(Name, pattern = "Johnny Ray") &
                                       grepl(Tm, pattern = "White Sox") ~ NA,
                                     
                                     grepl(Name, pattern = "Juan Gonzalez") &
                                       Year == 2021 ~ NA,
                                     
                                     grepl(Name, pattern = "Jake Miller") &
                                       grepl(Tm, pattern = "Cleveland") ~ NA,
                                     
                                     
                                     
                                     TRUE ~ bbref_id))
                
```

# Plotting {.tabset .tabset-pills .tabset-fade}

## Create and Populate DFs for Plotting

Create dfs

```{r Subsetting Astros and Cubs dfs for plotting, include = T, message = F, warning = F, echo = T}


  ## Join draft subset dfs with career WAR data -> How good drafting was
ASTROS_CUBS_DRAFT_SUB = ASTROS_CUBS_DRAFT_SUB %>%
  dplyr::select(-key_bbref) %>%
  left_join(CAREER_WAR_df, by = "bbref_id") %>%
  dplyr::select(-name_last, -name_first, -name_first, -name_given, -name_suffix, -name_matrilineal, -name_nick, -contains("key"), -contains("played")) %>%
  dplyr::mutate(Name = Name.x, .after = 7) %>%
  dplyr::select(-Name.x, -Name.y)

ASTROS_CUBS_DRAFT_SUB %>%
  dplyr::filter(Year != "2011") %>%
  dplyr::group_by(Tm) %>%
  dplyr::summarize(Career_bWAR = sum(Career_bWAR, na.rm = T)) %>%
  dplyr::arrange(desc(Career_bWAR))

LEAGUE_DRAFT_SUB = LEAGUE_DRAFT_SUB %>%
  dplyr::select(-key_bbref) %>%
  left_join(CAREER_WAR_df, by = "bbref_id") %>%
  dplyr::select(-name_last, -name_first, -name_first, -name_given, -name_suffix, -name_matrilineal, -name_nick, -contains("key"), -contains("played")) %>%
  dplyr::mutate(Name = Name.x, .after = 7) %>%
  dplyr::select(-Name.x, -Name.y)

options(scipen = 999)

Draft_Results = LEAGUE_DRAFT_SUB %>%
  dplyr::filter(Year > 2011) %>%
  dplyr::group_by(Tm, Year) %>%
  summarize(Career_bWAR = round(sum(Career_bWAR, na.rm = T),1)) %>%
  dplyr::arrange(desc(Career_bWAR))

  ## Create subset dfs of standings, value, international signing and free-agent data for the rest of the league
LEAGUE_STAND_SUB = StandALL[ which(StandALL$Tm != "Houston Astros" & StandALL$Tm != "Chicago Cubs"), ]
LEAGUE_VAL_SUB = TeamValALL[ which(TeamValALL$Tm != "Houston Astros" & TeamValALL$Tm != "Chicago Cubs"), ]
LEAGUE_INTL_SUB = IntlALL[ which(IntlALL$Team != "HOU" & IntlALL$Team != "CHC"), ]
LEAGUE_ESPN_SUB = ESPN[ which(ESPN$Team != "Astros" & ESPN$Team != "Cubs"), ]
```

Prepare `Astros`, `Cubs`, and `League` `Tanking` dfs

```{r TANK DF filling pt.1, include = T, message = F, warning = F, echo = T}
  ## Create separate dfs for the Cubs and Astros
ASTROS_TANK_DF = matrix(ncol = 18, nrow = length(seq(2011,2021)))
CUBS_TANK_DF = matrix(ncol = 18, nrow = length(seq(2011,2021)))

ASTROS_TANK_DF = as.data.frame(ASTROS_TANK_DF)
CUBS_TANK_DF = as.data.frame(CUBS_TANK_DF)

  ## Create column names
colnames(ASTROS_TANK_DF) = c("Year", "Win%", "# Top 5 picks", "# SS Drafted", "# P Drafted",
                             "# College Draftees", "# Draft Picks", "SS %", "P %", "College %",
                             "# Int'l Signings", "Int'l Signing Money Spent", "# FA Contracts",
                             "Mean FA AAV", "Mean FA Length", "Mean FA Total Value", "Team bWAR",
                             "Team payroll")

colnames(CUBS_TANK_DF) = colnames(ASTROS_TANK_DF)

  ## Create a df for lg avg stats to merge
LG_TANK_DF = matrix(nrow = nrow(ASTROS_TANK_DF), ncol = ncol(ASTROS_TANK_DF))
LG_TANK_DF = as.data.frame(LG_TANK_DF)
colnames(LG_TANK_DF) = colnames(ASTROS_TANK_DF)

  ## Add years
for(i in 1:nrow(ASTROS_TANK_DF)){
  ASTROS_TANK_DF[i,1] = seq(2011,2021)[i]
  CUBS_TANK_DF[i,1] = seq(2011,2021)[i]
  LG_TANK_DF[i,1] = seq(2011,2021)[i]
}

  ## Fill Win %
ASTROS_TANK_DF[-c(which(ASTROS_TANK_DF$Year == 2020)),2] = StandALL$`W-L%`[ which(StandALL$Tm == "Houston Astros") ]
CUBS_TANK_DF[-c(which(CUBS_TANK_DF$Year == 2020)),2] = StandALL$`W-L%`[ which(StandALL$Tm == "Chicago Cubs") ]
LG_TANK_DF$`Win%` = 0.500
```

Fill `# Top 5 picks` (shown) and remaining columns (not shown)

```{r TANK DF filling draft picks 2, include = T, message = F, warning = F, echo = T}

for (i in 11:21) {
  
  ASTROS_TANK_DF[i-10,3] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                               dplyr::filter(Tm == "Houston Astros" &
                                               Year == paste(20,i,sep = "") &
                                               Rd <= 5))
  CUBS_TANK_DF[i-10,3] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                                dplyr::filter(Tm == "Chicago Cubs" &
                                                Year == paste(20,i,sep = "") &
                                                Rd <= 5))
  
  LG_TANK_DF[i-10,3] = round(nrow(LEAGUE_DRAFT_SUB %>%
                                    dplyr::filter(Year == paste(20,i,sep = "") &
                                                    Rd <= 5)) / 28, digits = 2)
  
}
```

```{r TANK DF filling SSs 1, include = T, message = F, warning = F, echo = F}
for (i in 11:21) {
  
  ASTROS_TANK_DF[i-10,4] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                               dplyr::filter(Tm == "Houston Astros" &
                                               Year == paste(20,i,sep = "") &
                                               POS == "SS"))
  CUBS_TANK_DF[i-10,4] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                                dplyr::filter(Tm == "Chicago Cubs" &
                                                Year == paste(20,i,sep = "") &
                                                POS == "SS"))
  
  LG_TANK_DF[i-10,4] = round(nrow(LEAGUE_DRAFT_SUB %>%
                                    dplyr::filter(Year == paste(20,i,sep = "") &
                                                    POS == "SS")) / 28, digits = 2)
  
}
```

```{r TANK DF filling Ps, include = T, message = F, warning = F, echo = F}



for (i in 11:21) {
  
  if (i <= 17) {
    
    ## # Pitchers
    ASTROS_TANK_DF[i-10,5] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                               dplyr::filter(Tm == "Houston Astros" &
                                               Year == as.numeric(paste(20,i,sep = "")) &
                                               POS == "P"))
    
    CUBS_TANK_DF[i-10,5] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                                  dplyr::filter(Tm == "Chicago Cubs" &
                                                  Year == as.numeric(paste(20,i,sep = "")) &
                                                  POS == "P"))
    
    LG_TANK_DF[i-10,5] = round(nrow(LEAGUE_DRAFT_SUB %>%
                                      dplyr::filter(Year == as.numeric(paste(20,i,sep = "")) &
                                                      POS == "P")) / 28, digits = 2)
    
  } else {
    
    ASTROS_TANK_DF[i-10,5] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                               dplyr::filter(Tm == "Houston Astros" &
                                               Year == as.numeric(paste(20,i,sep = "")) &
                                               grepl(POS, pattern = "RHP|LHP")))
                               
    CUBS_TANK_DF[i-10,5] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                                  dplyr::filter(Tm == "Chicago Cubs" &
                                                  Year == as.numeric(paste(20,i,sep = "")) &
                                                  grepl(POS, pattern = "RHP|LHP")))
    
    LG_TANK_DF[i-10,5] = round(nrow(LEAGUE_DRAFT_SUB %>%
                                      dplyr::filter(Year == as.numeric(paste(20,i,sep = "")) &
                                                      grepl(POS, pattern = "RHP|LHP"))) / 28, digits = 2)
  }
}

for (i in 11:21) {
  
    ## # College picks
    ASTROS_TANK_DF[i-10,6] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                                    dplyr::filter(Tm == "Houston Astros" &
                                                    Year == as.numeric(paste(20,i,sep = "")) &
                                                    grepl(`Drafted From`, pattern = "University|College|UCLA|Cal Poly|Academy of Art|Institute of Technology|UNLV|State|Virginia Tech|Lipscomb|Santa Clara|Tusculum|JC")))
    
    CUBS_TANK_DF[i-10,6] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                                  dplyr::filter(Tm == "Chicago Cubs" &
                                                  Year == as.numeric(paste(20,i,sep = "")) &
                                                  grepl(`Drafted From`, pattern = "University|College|UCLA|Cal Poly|Academy of Art|Institute of Technology|UNLV|State|Virginia Tech|Lipscomb|Santa Clara|Tusculum|JC")))
    
    LG_TANK_DF[i-10,6] = round(nrow(LEAGUE_DRAFT_SUB %>%
                                      dplyr::filter(Year == as.numeric(paste(20,i,sep = "")) &
                                                      grepl(`Drafted From`, pattern = "University|College|UCLA|Cal Poly|Academy of Art|Institute of Technology|UNLV|State|Virginia Tech|Lipscomb|Santa Clara|Tusculum|JC"))) / 28, digits = 2)
}



for (i in 11:21){   
    ## Total # Picks
    ASTROS_TANK_DF[i-10,7] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                               dplyr::filter(Tm == "Houston Astros" &
                                               Year == as.numeric(paste(20,i,sep = ""))))
                               
    CUBS_TANK_DF[i-10,7] = nrow(ASTROS_CUBS_DRAFT_SUB %>%
                                  dplyr::filter(Tm == "Chicago Cubs" &
                                                  Year == as.numeric(paste(20,i,sep = ""))))
    
    LG_TANK_DF[i-10,7] = round(nrow(LEAGUE_DRAFT_SUB %>%
                                      dplyr::filter(Year == as.numeric(paste(20,i,sep = "")))) / 28, digits = 2)
}

for (i in 11:21){
    ## # Intl Picks
    ASTROS_TANK_DF[i-10,11] = nrow(IntlALL %>%
                               dplyr::filter(Team == "HOU" &
                                               Year == as.numeric(paste(20,i,sep = ""))))
                               
    CUBS_TANK_DF[i-10,11] = nrow(IntlALL %>%
                                  dplyr::filter(Team == "CHC" &
                                                  Year == as.numeric(paste(20,i,sep = ""))))
    
    LG_TANK_DF[i-10,11] = round(nrow(IntlALL %>%
                                      dplyr::filter(Year == as.numeric(paste(20,i,sep = "")) &
                                                      !grepl(Team, pattern = "(Astros)|(Cubs)"))) / 28, digits = 2)
}
    
for(i in 11:21){
    ## # FA signings
    ASTROS_TANK_DF[i-10,13] = nrow(ESPN %>% ungroup() %>%
                                     dplyr::filter(Team == "Astros" &
                                                     Type == "MLB" &
                                                     Year == as.numeric(paste(20,i,sep = ""))))
    
    CUBS_TANK_DF[i-10,13] = nrow(ESPN %>% ungroup() %>%
                                   dplyr::filter(Team == "Cubs" &
                                                   Type == "MLB" &
                                                   Year == as.numeric(paste(20,i,sep = ""))))
    
    LG_TANK_DF[i-10,13] = round(nrow(ESPN %>% ungroup() %>%
                                       dplyr::filter(Type == "MLB" &
                                                       !grepl(Team, pattern = "(Astros)|(Cubs)") &
                                                       Year == as.numeric(paste(20,i,sep = ""))))/ 28, digits = 2)
}

for(i in 11:21){
    ## FA avg AAV
    ASTROS_TANK_DF[i-10,14] = round(mean(ESPN %>% ungroup() %>%
                                           dplyr::filter(Team == "Astros" &
                                                           Type == "MLB" &
                                                           Year == as.numeric(paste(20,i,sep = ""))) %>%
                                           dplyr::select(AAV) %>% unlist() %>% as.numeric(), na.rm = T), digits = 3)
    
    CUBS_TANK_DF[i-10,14] = round(mean(ESPN %>% ungroup() %>%
                                         dplyr::filter(Team == "Cubs" &
                                                         Type == "MLB" &
                                                         Year == as.numeric(paste(20,i,sep = ""))) %>%
                                         dplyr::select(AAV) %>% unlist() %>% as.numeric(), na.rm = T), digits = 3)
    
    LG_TANK_DF[i-10,14] = round(mean(ESPN %>% ungroup() %>%
                                       dplyr::filter(Type == "MLB" &
                                                       !grepl(Team, pattern = "(Astros)|(Cubs)") &
                                                       Year == as.numeric(paste(20,i,sep = ""))) %>%
                                       dplyr::select(AAV) %>% unlist() %>% as.numeric(), na.rm = T), digits = 3)
}

for(i in 11:21){
    ## Contract Length Total
    ASTROS_TANK_DF[i-10,15] = round(mean(ESPN %>% ungroup() %>%
                                           dplyr::filter(Team == "Astros" &
                                                           Yrs != "" &
                                                           Year == as.numeric(paste(20,i,sep = ""))) %>%
                                           dplyr::select(Yrs) %>% unlist() %>% as.numeric(), na.rm = T ), digits = 2)
    
    CUBS_TANK_DF[i-10,15] = round(mean(ESPN %>% ungroup() %>%
                                         dplyr::filter(Team == "Cubs" &
                                                         Yrs != "" &
                                                         Year == as.numeric(paste(20,i,sep = ""))) %>%
                                         dplyr::select(Yrs) %>% unlist() %>% as.numeric(), na.rm = T), digits = 2)
    
    LG_TANK_DF[i-10,15] = round(mean(ESPN %>% ungroup() %>%
                                       dplyr::filter(Yrs != "" &
                                                       !grepl(Team, pattern = "(Astros)|(Cubs)") &
                                                       Year == as.numeric(paste(20,i,sep = ""))) %>%
                                       dplyr::select(Yrs) %>% unlist() %>% as.numeric(), na.rm = T), digits = 2)
}

for(i in 11:21){    
    ## Contract Total Length
    ASTROS_TANK_DF[i-10,16] = round(mean(ESPN %>% ungroup() %>%
                                          dplyr::filter(Team == "Astros" &
                                                          Yrs != "" &
                                                          Year == as.numeric(paste(20,i,sep = ""))) %>%
                                          dplyr::select(TotalValue) %>% unlist() %>% as.numeric(), na.rm = T), digits = 3)
    
    CUBS_TANK_DF[i-10,16] = round(mean(ESPN %>% ungroup() %>%
                                         dplyr::filter(Team == "Cubs" &
                                                         Yrs != "" &
                                                         Year == as.numeric(paste(20,i,sep = ""))) %>%
                                         dplyr::select(TotalValue) %>% unlist() %>% as.numeric(), na.rm = T), digits = 3)
    
    LG_TANK_DF[i-10,16] = round(mean(ESPN %>% ungroup() %>%
                                       dplyr::filter(Yrs != "" &
                                                       Year == as.numeric(paste(20,i,sep = "")) &
                                                       !grepl(Team, pattern = "(Astros)|(Cubs)")) %>%
                                       dplyr::select(TotalValue) %>% unlist() %>% as.numeric(), na.rm = T), digits = 3)
}
 
for (i in 11:21){   
    ## Team WAR
  if(i == 20) {
    
    ASTROS_TANK_DF[i-10,17] = NA
    CUBS_TANK_DF[i-10,17] = NA
    LG_TANK_DF[i-10,17] = NA
    
  } else {
    ASTROS_TANK_DF[i-10,17] = round(TeamValALL %>% ungroup() %>%
                                      dplyr::filter(Team == "Houston Astros" &
                                                      Year == as.numeric(paste(20,i,sep = ""))) %>%
                                      dplyr::select(WAR) %>% unlist() %>% as.numeric(), digits = 1)
    
    CUBS_TANK_DF[i-10,17] = round(TeamValALL %>% ungroup() %>%
                                    dplyr::filter(Team == "Chicago Cubs" &
                                                    Year == as.numeric(paste(20,i,sep = ""))) %>%
                                    dplyr::select(WAR) %>% unlist() %>% as.numeric(), digits = 1)
    
    LG_TANK_DF[i-10,17] = round(median(TeamValALL %>% ungroup() %>%
                                          dplyr::filter(!grepl(Team, pattern = "(Houston Astros)|(Chicago Cubs)") &
                                                          Year == as.numeric(paste(20,i,sep = ""))) %>%
                                          dplyr::select(WAR) %>% unlist() %>% as.numeric() ), digits = 1)
  }
}
 
for(i in 11:21){   
  
  if(i == 20){
    
    ASTROS_TANK_DF[i-10,18] = NA
    CUBS_TANK_DF[i-10,18] = NA
    LG_TANK_DF[i-10,18] = NA
    
  } else {
    ## Team Salary
    ASTROS_TANK_DF[i-10,18] = round(TeamValALL %>% ungroup() %>%
                                      dplyr::filter(Team == "Houston Astros" &
                                                      Year == as.numeric(paste(20,i,sep = ""))) %>%
                                      dplyr::select(Salary) %>% unlist() %>% as.numeric(), digits = 3)
    
    CUBS_TANK_DF[i-10,18] = round(TeamValALL %>% ungroup() %>%
                                    dplyr::filter(Team == "Chicago Cubs" &
                                                    Year == as.numeric(paste(20,i,sep = ""))) %>%
                                    dplyr::select(Salary) %>% unlist() %>% as.numeric(), digits = 3)
    
    LG_TANK_DF[i-10,18] = round(median(TeamValALL %>% ungroup() %>%
                                          dplyr::filter(!grepl(Team, pattern = "(Houston Astros)|(Chicago Cubs)") &
                                                          Year == as.numeric(paste(20,i,sep = ""))) %>%
                                          dplyr::select(Salary) %>% unlist() %>% as.numeric() ), digits = 3)
  }
}

    ## # Total Spent on Int'l FAs
for (i in 11:21) {
  if (i == 11) {
    
    ASTROS_TANK_DF[i-10,12] = 0
    
    CUBS_TANK_DF[i-10,12] = sum(IntlALL %>%
                                  dplyr::filter(Team == "CHC" &
                                                  Year == as.numeric(paste(20,i,sep = ""))) %>%
                                  dplyr::select(Bonus) %>% unlist() %>% as.numeric(), na.rm = T)
    
    LG_TANK_DF[i-10,12] = sum(IntlALL %>%
                                dplyr::filter(!grepl(Team, pattern = "(HOU)|(CHC)") &
                                                Year == paste(20,i,sep = "")) %>%
                                dplyr::select(Bonus) %>% unlist() %>% as.numeric(), na.rm = T)
    
  } else {
    
    ASTROS_TANK_DF[i-10,12] = sum(IntlALL %>%
                                      dplyr::filter(Team == "HOU" &
                                                      Year == as.numeric(paste(20,i,sep = ""))) %>%
                                      dplyr::select(Bonus) %>% unlist() %>% as.numeric(), na.rm = T)
    
    CUBS_TANK_DF[i-10,12] = sum(IntlALL %>%
                                  dplyr::filter(Team == "CHC" &
                                                  Year == as.numeric(paste(20,i,sep = ""))) %>%
                                  dplyr::select(Bonus) %>% unlist() %>% as.numeric(), na.rm = T)
    
    LG_TANK_DF[i-10,12] = sum(IntlALL %>%
                                dplyr::filter(!grepl(Team, pattern = "(HOU)|(CHC)") &
                                                Year == as.numeric(paste(20,i,sep = ""))) %>%
                                dplyr::select(Bonus) %>% unlist() %>% as.numeric(), na.rm = T)
    
  }
}


## Fill % of picks on SSs
ASTROS_TANK_DF[,8] = round((ASTROS_TANK_DF[,4] / ASTROS_TANK_DF[,7])*100, digits = 2)
CUBS_TANK_DF[,8] = round((CUBS_TANK_DF[,4] / CUBS_TANK_DF[,7])*100, digits = 2)
LG_TANK_DF[,8] = round((LG_TANK_DF[,4] / LG_TANK_DF[,7])*100, digits = 2)
## Fill % of picks on Ps
ASTROS_TANK_DF[,9] = round((ASTROS_TANK_DF[,5] / ASTROS_TANK_DF[,7])*100, digits = 2)
CUBS_TANK_DF[,9] = round((CUBS_TANK_DF[,5] / CUBS_TANK_DF[,7])*100, digits = 2)
LG_TANK_DF[,9] = round((LG_TANK_DF[,5] / LG_TANK_DF[,7])*100, digits = 2)
## Fill % of picks on college players
ASTROS_TANK_DF[,10] = round((ASTROS_TANK_DF[,6] / ASTROS_TANK_DF[,7])*100, digits = 2)
CUBS_TANK_DF[,10] = round((CUBS_TANK_DF[,6] / CUBS_TANK_DF[,7])*100, digits = 2)
LG_TANK_DF[,10] = round((LG_TANK_DF[,6] / LG_TANK_DF[,7])*100, digits = 2)

```

Add `Career bWAR` of draftees to the dfs

```{r Merge TANK DFs, include = T, message = F, warning = F, echo = T}
## Add Career WAR of draftees
ASTROS_TANK_DF = ASTROS_CUBS_DRAFT_SUB %>%
  group_by(Year) %>%
  filter(Tm == "Houston Astros") %>%
  summarize(Draft_Class_Career_WAR = sum(Career_bWAR, na.rm = T)) %>%
  select(Draft_Class_Career_WAR) %>%
  bind_cols(ASTROS_TANK_DF)

ASTROS_TANK_DF = ASTROS_TANK_DF %>%
  relocate(Draft_Class_Career_WAR, .after = 19)

CUBS_TANK_DF = ASTROS_CUBS_DRAFT_SUB %>%
  group_by(Year) %>%
  filter(Tm == "Chicago Cubs") %>%
  summarize(Draft_Class_Career_WAR = sum(Career_bWAR, na.rm = T)) %>%
  select(Draft_Class_Career_WAR) %>%
  bind_cols(CUBS_TANK_DF)

CUBS_TANK_DF = CUBS_TANK_DF %>%
    relocate(Draft_Class_Career_WAR, .after = 19)

LG_TANK_DF = LEAGUE_DRAFT_SUB %>%
  group_by(Year) %>%
  summarize(Draft_Class_Career_WAR = sum(Career_bWAR, na.rm = T)/28) %>%
  select(Draft_Class_Career_WAR) %>%
  bind_cols(LG_TANK_DF)

LG_TANK_DF = LG_TANK_DF %>%
  relocate(Draft_Class_Career_WAR, .after = 19)
LG_TANK_DF[ , 19] = round(LG_TANK_DF[ , 19], digits = 1)
  
## Add "WARPM" (WAR Per Million $) col
ASTROS_TANK_DF$WARPM = round(ASTROS_TANK_DF$`Team bWAR` / ASTROS_TANK_DF$`Team payroll`, digits = 2)
CUBS_TANK_DF$WARPM = round(CUBS_TANK_DF$`Team bWAR` / CUBS_TANK_DF$`Team payroll`, digits = 2)
LG_TANK_DF$WARPM = round(LG_TANK_DF$`Team bWAR` / LG_TANK_DF$`Team payroll`, digits = 2)

## Add Team col
ASTROS_TANK_DF$Tm = "Houston Astros"
CUBS_TANK_DF$Tm = "Chicago Cubs"
LG_TANK_DF$Tm = "LeagueAVG"
TANK_DF = rbind.data.frame(ASTROS_TANK_DF, CUBS_TANK_DF, LG_TANK_DF)
```

## Create and Clean the df for Tankers

```{r REBUILDERS_df and plotly creation, include = TRUE, warning = FALSE, echo = TRUE, message = FALSE}
REBUILDERS_df = TeamValALL %>%
  group_by(`Tm`, Year) %>%
  filter(L >= 92)

  ## Remove the Red Sox, Indians/Guardians, Brewers, Mets, Giants, Rays, Jays, Nats (idx = 5, 7, 23, 35, 40, 30, 52, 58)
REBUILDERS_df = REBUILDERS_df[ -c(5, 7, 23, 35, 40, 30, 52, 58), ]

REBUILDERS_df = REBUILDERS_df %>%
  group_by(`Tm`, Year) %>%
  arrange(`Tm`, Year) %>%
  ungroup()

REBUILDERS_df$GB = as.double(REBUILDERS_df$GB)
colnames(REBUILDERS_df)[c(8:13)] = c("MLB Trades Made", "FA Signings", "Minors Callups", "Payroll Sum", "bWAR", "Payroll (in M $US)")
head(REBUILDERS_df[c(4,5,7:11,13:16,20:27,31:38,41,42,45,46,52:54),-11])

  ## Remove non-qualifiers
Printable_REBUILD = REBUILDERS_df[c(4,5,7:11,13:16,20:27,31:38,41,42,45,46),-11]

  ## Re-arrange for display
Printable_REBUILD = Printable_REBUILD %>%
  select(`Tm`, Year, W, L, W_L, GB, DivRank, `MLB Trades Made`, `FA Signings`, `Minors Callups`, bWAR, `Payroll (in M $US)`)

  ## For plotting
Rebuild_T = plot_ly(
  type = 'table',
  columnwidth = c(rep(20,12)),
  columnorder = c(seq(1,12,1)),
  header = list(
    values = c(colnames(Printable_REBUILD)),
    align = c("center", "center"),
    line = list(width = 1, color = 'black'),
    fill = list(color = c("grey", "grey")),
    font = list(family = "Times", size = 14, color = "black")
  ),
  cells = list(
    values = rbind(Printable_REBUILD$Tm,
                   Printable_REBUILD$Year,
                   Printable_REBUILD$W,
                   Printable_REBUILD$L,
                   Printable_REBUILD$W_L,
                   Printable_REBUILD$GB,
                   Printable_REBUILD$DivRank,
                   Printable_REBUILD$`MLB Trades Made`,
                   Printable_REBUILD$`FA Signings`,
                   Printable_REBUILD$`Minors Callups`,
                   Printable_REBUILD$bWAR,
                   Printable_REBUILD$`Payroll (in M $US)`),
    align = c("center", "center"),
    line = list(color = "black", width = 1),
    font = list(family = "Times", size = 12, color = c("black"))
  ))
```
